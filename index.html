<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>IMPERIAL TECHUB â€” v1.3.5</title>
<meta name="description" content="IMPERIAL TECHUB - PCEA Youth" />
<style>
  :root{
    --royal:#002366; --accent:#25D366; --accent-2:#00b4ff;
    --bg1: linear-gradient(135deg,#002b70,#003b99);
    --card: rgba(255,255,255,0.03); --muted: rgba(220,230,240,0.75);
    --maxw:1200px;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    background: var(--bg1);
    color:#fff;
    -webkit-font-smoothing:antialiased;
  }
  main{max-width:var(--maxw);margin:18px auto;padding:0 14px}

  /* Intro (5s) */
  #intro{
    position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
    background:#001F4D;z-index:9999;animation:introFade 5s linear forwards;
  }
  @keyframes introFade{0%{opacity:1}95%{opacity:1}100%{opacity:0;visibility:hidden}}
  #intro h1{font-size:clamp(2rem,6vw,4rem);letter-spacing:2px;color:#cfe9ff;font-weight:900;margin-bottom:10px}
  .glow{width:18px;height:18px;border-radius:50%;background:var(--accent-2);box-shadow:0 0 0 rgba(0,180,255,0.4);animation:glow 1.6s infinite}
  @keyframes glow{0%{box-shadow:0 0 0 0 rgba(0,180,255,.45)}60%{box-shadow:0 0 0 28px rgba(0,180,255,0)}100%{box-shadow:0 0 0 0 rgba(0,180,255,0)}}

  /* Top nav hidden until login */
  header.topbar{position:sticky;top:0;background:rgba(0,0,0,0.12);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,0.03);z-index:900;display:none}
  .nav-inner{max-width:var(--maxw);margin:0 auto;padding:10px 14px;display:flex;align-items:center;justify-content:space-between}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--accent-2),#62d3ff);display:flex;align-items:center;justify-content:center;color:#012;font-weight:900}
  .nav-links{display:flex;gap:8px;flex-wrap:wrap}
  .nav-btn{background:transparent;border:0;color:#fff;padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer}
  .nav-btn.active{color:var(--accent-2);background:rgba(255,255,255,0.03)}

  /* Layout */
  .card{background:var(--card);border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 30px rgba(0,0,0,0.35)}
  .center{text-align:center}
  input,select,textarea{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;width:100%;margin-top:8px}
  button{padding:10px 12px;border-radius:8px;border:0;background:var(--accent-2);color:#012;font-weight:800;cursor:pointer}
  .muted{color:var(--muted)}

  /* WhatsApp-like chat */
  .whatsapp-app{display:grid;grid-template-columns:320px 1fr;gap:12px;margin-top:12px}
  .convo-list{height:70vh;overflow:auto}
  .convo-item{display:flex;gap:10px;align-items:center;padding:10px;border-radius:8px;cursor:pointer}
  .convo-item:hover{background:rgba(255,255,255,0.02)}
  .avatar{width:46px;height:46px;border-radius:50%;background:#fff;color:#012;display:flex;align-items:center;justify-content:center;font-weight:900}
  .messages{height:64vh;overflow:auto;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02))}
  .bubble{display:inline-block;padding:10px;border-radius:12px;margin:8px 0;max-width:70%}
  .bubble.me{background:linear-gradient(90deg,var(--accent-2),#66d8ff);color:#012;margin-left:auto}
  .bubble.other{background:rgba(255,255,255,0.03)}
  .composer{display:flex;gap:8px;align-items:center;margin-top:10px}
  .composer input[type="text"]{flex:1;padding:12px;border-radius:999px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
  .send-btn{background:var(--accent);color:#012;border-radius:999px;padding:10px 14px;border:0;font-weight:800}

  /* Responsive small */
  @media (max-width:900px){
    .whatsapp-app{grid-template-columns:1fr}
    .convo-list{height:30vh}
    .messages{height:40vh}
  }

  /* Footer */
  footer{margin-top:20px;text-align:center;color:rgba(255,255,255,0.95);padding-bottom:28px}
  .hidden{display:none!important}
  .small{font-size:.92rem}
  a.chip{background:#25D366;color:#012;padding:6px 8px;border-radius:8px;display:inline-block;margin-right:6px;text-decoration:none;font-weight:700}
</style>
</head>
<body>

  <!-- Intro -->
  <div id="intro" aria-hidden="true">
    <h1>IMPERIAL TECHUB</h1>
    <div class="glow" aria-hidden="true"></div>
  </div>

  <!-- Topbar (hidden until signed in) -->
  <header class="topbar" id="topbar">
    <div class="nav-inner">
      <div class="brand"><div class="logo">IT</div><div style="font-weight:900">IMPERIAL TECHUB</div></div>
      <nav class="nav-links" id="navlinks" aria-label="Main navigation">
        <button class="nav-btn" data-page="home">HOME</button>
        <button class="nav-btn" data-page="events">EVENTS</button>
        <button class="nav-btn" data-page="announcements">ANNOUNCEMENTS</button>
        <button class="nav-btn" data-page="calendar">CALENDAR</button>
        <button class="nav-btn" data-page="leaders">LEADERS</button>
        <button class="nav-btn" data-page="hymnbook">HYMNBOOK</button>
        <button class="nav-btn" data-page="membership">MEMBERSHIP</button>
        <button class="nav-btn" data-page="video">MEETING</button>
        <button class="nav-btn" data-page="bible">BIBLE</button>
        <button class="nav-btn" data-page="chat">CHAT</button>
      </nav>
    </div>
  </header>

  <main>
    <!-- Auth area (appears after intro) -->
    <section id="authArea" class="card" style="max-width:920px;margin:48px auto;display:none">
      <h2>Sign in to IMPERIAL TECHUB</h2>

      <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
        <input id="signinEmail" placeholder="Email" type="email" style="flex:1;min-width:220px" />
        <input id="signinPassword" placeholder="Password" type="password" style="flex:1;min-width:220px" />
      </div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="btnSignIn">Sign In</button>
        <button id="btnGoogle" style="background:#fff;color:#012">Sign in with Google</button>
        <button id="btnOpenRegister" style="background:#3b82f6">Create account</button>
      </div>
      <div id="signinMsg" class="muted small" style="margin-top:8px"></div><div style="margin-top:10px" class="muted-small">
        <strong>Why sign in?</strong>
        <ul>
          <li>Access Bible, Chat & Meetings</li>
          <li>Join events, see announcements and contact leaders</li>
        </ul>
      </div>
    </section>

    <!-- Register modal -->
    <div id="registerModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:2000">
      <div style="background:#fff;color:#012;padding:16px;border-radius:10px;width:760px;max-width:96%">
        <h3>Create account</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <input id="regFullName" placeholder="Full name" />
          <input id="regUsername" placeholder="Username" />
          <input id="regEmail" placeholder="Email" />
          <input id="regPhone" placeholder="Phone (+254...)" />
          <input id="regChurch" placeholder="Church" />
          <input id="regDistrict" placeholder="District" />
          <label style="grid-column:1/3">Profile photo: <input id="regPhoto" type="file" accept="image/*" /></label>
          <input id="regPassword" type="password" placeholder="Password" />
          <input id="regPassword2" type="password" placeholder="Confirm password" />
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button id="btnCancelRegister" style="background:#ddd;color:#012">Cancel</button>
          <button id="btnCreateAccount">Create account</button>
        </div>
        <div id="regMsg" style="margin-top:8px;color:#333"></div>
      </div>
    </div>

    <!-- The full app (hidden until login) -->
    <div id="appWrapper" class="hidden">

      <!-- Home & Fun Fact -->
      <section id="home" class="card center" style="margin-top:18px">
        <h2 id="welcomeTitle">Welcome</h2>
        <p id="funFact" style="font-size:1.05rem;margin-top:6px"></p>
        <small class="muted">New fact every 24 hours</small>
      </section>

      <!-- Events & announcements -->
      <div style="display:grid;grid-template-columns:1fr 420px;gap:12px;margin-top:12px">
        <div class="card">
          <h3>Events & Countdowns</h3>
          <div id="eventsGrid" style="margin-top:10px"></div>
        </div>
        <div class="card">
          <h3>Announcements</h3>
          <div style="margin-top:8px">
            <div><strong>PCEA NGORANO PARISH YOUTH RALLY</strong><div class="muted">Sunday, 16th November 2025 â€” PCEA Chieni Church</div></div>
            <hr style="border-color:rgba(255,255,255,0.03);margin:8px 0" />
            <div><strong>PRESBYTERY YOUTH CONVENTION</strong><div class="muted">2nd â€” 6th December 2025 â€” Fee Ksh 1,500</div></div>
          </div>
        </div>
      </div>

      <!-- Leaders + Quick -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
        <div class="card">
          <h3>Leaders</h3>
          <div id="leadersGrid"></div>
        </div>
        <div class="card">
          <h3>Quick Access</h3>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button id="openBible">Open Bible</button>
            <button id="openChat">Open Chat</button>
            <button id="joinMeeting">Join Meeting</button>
          </div>
        </div>
      </div>

      <!-- Bible (hidden until opened) -->
      <section id="bibleSection" class="card hidden" style="margin-top:12px">
        <div style="display:flex;gap:8px;align-items:center">
          <select id="bookSelect"></select>
          <select id="chapterSelect"></select>
          <input id="hymnVerseSearch" placeholder="Search bible or phrase" style="flex:1" />
        </div>
        <div id="versesContainer" style="margin-top:12px"></div>
      </section>

      <!-- Chat (WhatsApp-style) -->
      <section id="chatSection" class="card hidden" style="margin-top:12px">
        <h3>Chat</h3>
        <div class="whatsapp-app">
          <!-- Conversations -->
          <div>
            <div class="card" style="margin-bottom:8px">
              <input id="convoSearch" placeholder="Search chats..." />
            </div>
            <div class="card convo-list" id="convoList"></div>
          </div>

          <!-- Messages -->
          <div>
            <div class="card messages" id="messagesWindow"></div>
            <div class="composer">
              <input id="messageInput" type="text" placeholder="Type a message" />
              <input id="fileUpload" type="file" accept="image/*,audio/*" style="display:none" />
              <button id="attachBtn" class="inline-btn">ðŸ“Ž</button>
              <button id="sendMsgBtn" class="send-btn">Send</button>
            </div>
            <div id="typingIndicator" class="muted small" style="margin-top:6px"></div>
          </div>
        </div>
      </section>

      <footer>PROUDLY CREATED BY <strong>IAN GATHAGU</strong> â€” v1.3.5</footer>
    </div>

  </main>

  <!-- Meeting modal (embed vs fallback) -->
  <div id="meetModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);align-items:center;justify-content:center;z-index:3000">
    <div style="background:#fff;color:#012;padding:12px;border-radius:8px;width:95%;max-width:1000px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">Join Meeting</div>
        <div><button id="closeMeet" style="background:#ff7676;border:0;padding:8px;border-radius:6px">Close</button></div>
      </div>
      <div id="meetBody" style="height:640px;margin-top:8px"></div>
    </div>
  </div>

  <!-- Firebase modular SDK (v10) and app logic -->
  <script type="module">
  // ---------- Imports ----------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, onSnapshot, orderBy, serverTimestamp, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

  // ---------- Firebase config (your config) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyBNnNfTHE6h-hnTW6LAixiAJ7X--HMTMA0",
    authDomain: "imperial-techub.firebaseapp.com",
    projectId: "imperial-techub",
    storageBucket: "imperial-techub.firebasestorage.app",
    messagingSenderId: "361070773876",
    appId: "1:361070773876:web:ce41754e58a058e827f321"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // ---------- Helpers ----------
  const $ = id => document.getElementById(id);
  const show = el => el && el.classList.remove('hidden') && (el.style.display='block');
  const hide = el => el && el.classList.add('hidden') && (el.style.display='none');
  const create = (tag, attrs={}, html='') => { const e=document.createElement(tag); Object.assign(e, attrs); if(html) e.innerHTML=html; return e; };
  function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // ---------- Intro -> show auth area ----------
  document.addEventListener('DOMContentLoaded', ()=>{
    const intro = $('intro');
    intro.addEventListener('animationend', ()=> {
      intro.style.display = 'none';
      $('authArea').style.display = 'block';
    });setTimeout(()=>{ if(intro.style.display !== 'none'){ intro.style.display='none'; $('authArea').style.display='block'; } }, 5200);
  });

  // ---------- Auth UI wiring ----------
  $('btnOpenRegister').addEventListener('click', ()=> { $('registerModal').classList.remove('hidden'); $('registerModal').style.display='flex'; });
  $('btnCancelRegister').addEventListener('click', ()=> { $('registerModal').classList.add('hidden'); $('registerModal').style.display='none'; });

  // Create account
  $('btnCreateAccount').addEventListener('click', async ()=>{
    const fullName = $('regFullName').value.trim();
    const username = $('regUsername').value.trim();
    const email = $('regEmail').value.trim();
    const phone = $('regPhone').value.trim();
    const church = $('regChurch').value.trim();
    const district = $('regDistrict').value.trim();
    const p1 = $('regPassword').value;
    const p2 = $('regPassword2').value;
    if(!fullName||!username||!email||!phone||!p1){ $('regMsg').innerText = 'Please fill required fields'; return; }
    if(p1 !== p2){ $('regMsg').innerText = 'Passwords do not match'; return; }
    $('regMsg').innerText = 'Creating account...';
    try{
      const cred = await createUserWithEmailAndPassword(auth, email, p1);
      const uid = cred.user.uid;
      let photoURL = '';
      const file = $('regPhoto').files[0];
      if(file){
        const ref = sRef(storage, `profiles/${uid}/${file.name}`);
        await uploadBytes(ref, file);
        photoURL = await getDownloadURL(ref);
      }
      await setDoc(doc(db,'users',uid), { fullName, username, email, phone, church, district, photoURL, createdAt: serverTimestamp(), lastSeen: serverTimestamp(), online:true });
      $('regMsg').innerText = 'Account created';
      $('registerModal').classList.add('hidden');
    }catch(err){ console.error(err); $('regMsg').innerText = 'Error: ' + err.message; }
  });

  // Email sign-in
  $('btnSignIn').addEventListener('click', async ()=>{
    const email = $('signinEmail').value.trim();
    const pw = $('signinPassword').value;
    if(!email||!pw){ $('signinMsg').innerText = 'Enter email and password'; return; }
    $('signinMsg').innerText = 'Signing in...';
    try{
      await signInWithEmailAndPassword(auth, email, pw);
      $('signinMsg').innerText = '';
    }catch(err){ console.error(err); $('signinMsg').innerText = 'Sign-in failed: ' + err.message; }
  });

  // Google sign-in
  $('btnGoogle').addEventListener('click', async ()=>{
    const provider = new GoogleAuthProvider();
    try{
      await signInWithPopup(auth, provider);
    }catch(err){ console.error(err); $('signinMsg').innerText = 'Google sign-in failed: ' + err.message; }
  });

  // ---------- Auth state handling ----------
  let convoUnsub = null;
  onAuthStateChanged(auth, async user => {
    if(user){
      // show nav & app
      $('topbar').style.display = 'block';
      $('appWrapper').classList.remove('hidden');
      $('authArea').style.display = 'none';
      $('welcomeTitle').innerText = `Welcome, ${user.displayName || user.email || 'Youth'}`;
      // ensure user doc exists
      const uref = doc(db,'users',user.uid);
      const usnap = await getDoc(uref);
      if(!usnap.exists()){
        await setDoc(uref, { fullName:user.displayName||'', email:user.email||'', phone:user.phoneNumber||'', createdAt: serverTimestamp(), lastSeen: serverTimestamp(), online:true });
      } else {
        await setDoc(uref, { lastSeen: serverTimestamp(), online:true }, { merge:true });
      }
      // initial app load
      setFunFact();
      renderLeaders();
      renderEvents();
      bindTopNav();
      // subscribe conversations list
      subscribeConversations();
    } else {
      // signed out
      $('topbar').style.display = 'none';
      $('appWrapper').classList.add('hidden');
      $('authArea').style.display = 'block';
      // unsubscribe conversations
      if(convoUnsub){ convoUnsub(); convoUnsub=null; }
    }
  });

  // Sign out btn in leaders quick area (we'll reuse)
  // Provide a global sign-out function
  window.appSignOut = async function(){
    try{
      if(auth.currentUser){
        await setDoc(doc(db,'users',auth.currentUser.uid), { online:false, lastSeen: serverTimestamp() }, { merge:true });
      }
    }catch(e){ console.warn(e); }
    await signOut(auth);
  };

  // ---------- Top nav binding ----------
  function bindTopNav(){
    document.querySelectorAll('.nav-btn').forEach(b=>{
      b.onclick = (e)=>{
        document.querySelectorAll('#appWrapper > section, #appWrapper > div.card, #bibleSection, #chatSection').forEach(x=>x.classList.add('hidden'));
        const page = b.dataset.page;
        if(page==='home'){ document.getElementById('home').classList.remove('hidden'); window.scrollTo({top:0,behavior:'smooth'}); }
        else if(page==='events'){ document.getElementById('eventsGrid').parentElement.classList.remove('hidden'); }
        else if(page==='leaders'){ document.getElementById('leadersGrid').parentElement.classList.remove('hidden'); }
        else if(page==='bible'){ openBible(); }
        else if(page==='chat'){ openChat(); }
        else if(page==='video'){ openMeet(); }
        else alert(page+' page not implemented yet.');
      };
    });
  }

  // ---------- Fun facts (rotate daily) ----------
  const FUN_FACTS = [
    "Psalm 119 is the longest chapter in the Bible.",
    "The shortest verse is John 11:35 â€” 'Jesus wept.'",
    "The Bible was written by about 40 authors over 1600 years.",
    "Psalm 23 is one of the most beloved psalms worldwide.",
    "The first book of the Bible is Genesis; the last is Revelation."
  ];
  function setFunFact(){
    const today = new Date().toDateString();
    const stored = JSON.parse(localStorage.getItem('it_funfact') || 'null');
    if(!stored || stored.date !== today){
      const f = FUN_FACTS[Math.floor(Math.random()*FUN_FACTS.length)];
      localStorage.setItem('it_funfact', JSON.stringify({ date: today, fact: f }));
      $('funFact').innerText = f;
    } else $('funFact').innerText = stored.fact;
  }

  // ---------- Leaders ----------
  function renderLeaders(){
    const leaders = [
      { office:"Zachary's Office", name:"Zachary Gikonyo", role:"Chairperson", phone:"+254742892647" },
      { office:"Dalson's Office", name:"Dalson Maina", role:"Vice Chairperson", phone:"+254714003648" },
      { office:"Ian's Office", name:"Ian Gathagu", role:"Secretary", phone:"+254718357417" },
      { office:"Lydia's Office", name:"Lydia Wamuyu", role:"Vice Secretary", phone:"+254110867929" },
      { office:"Winnie's Office", name:"Winnie Maundu", role:"Treasurer", phone:"+254713285534" }
    ];
    const grid = $('leadersGrid'); grid.innerHTML = '';
    leaders.forEach(ld=>{
      const node = create('div',{},`<div style="font-weight:800">${ld.office}</div><div class="muted small">${ld.name} â€” ${ld.role}</div><div style="margin-top:8px"><a class="chip" href="https://wa.me/${ld.phone.replace(/\\D/g,'')}" target="_blank">WhatsApp</a><a class="chip" href="tel:${ld.phone.replace(/\\D/g,'')}" style="background:#ffd54f">Call</a></div>`);
      grid.appendChild(node);
    });
    }// ---------- Events & countdowns ----------
  const EVENTS = [
    { id:'youth_rally', title:'Youth Rally â€” PCEA Chieni Church', start:'2025-11-16T09:00:00' },
    { id:'presbytery', title:'Presbytery Youth Convention', start:'2025-12-02T09:00:00' },
    { id:'christmas', title:'Christmas Day', start:'2025-12-25T00:00:00' },
    { id:'newyear', title:"New Year's Day", start:'2026-01-01T00:00:00' }
  ];
  function renderEvents(){
    const grid = $('eventsGrid'); grid.innerHTML = '';
    const now = new Date();
    const mapped = EVENTS.map(e=>({ ...e, startDate: new Date(e.start), diff: new Date(e.start) - now })).sort((a,b)=>a.diff - b.diff);
    mapped.forEach(ev=>{
      const wrapper = create('div',{},`<div style="font-weight:800">${esc(ev.title)}</div><div class="muted small">${ev.startDate.toDateString()}</div><div id="cd-${ev.id}" style="font-family:monospace;color:var(--accent-2);margin-top:6px"></div>`);
      wrapper.style.marginTop='10px';
      grid.appendChild(wrapper);
    });
    setInterval(()=> {
      const now = new Date();
      EVENTS.forEach(ev=>{
        const el = $('cd-'+ev.id);
        if(!el) return;
        const diff = new Date(ev.start) - now;
        if(diff<=0){ el.innerText = 'Happening or passed'; return; }
        const d = Math.floor(diff/(24*3600*1000));
        const h = Math.floor((diff%(24*3600*1000))/(3600*1000));
        const m = Math.floor((diff%(3600*1000))/(60000));
        const s = Math.floor((diff%60000)/1000);
        el.innerText = `${d}d ${h}h ${m}m ${s}s`;
      });
    }, 1000);
  }

  // ---------- Bible (basic loader, expects /bible/books.json or fallback sample) ----------
  const SAMPLE = { "Genesis": [{"verse":"1","text":"In the beginning God created the heaven and the earth."}, {"verse":"2","text":"And the earth was without form, and void..."}], "Exodus":[{"verse":"1","text":"Now these are the names of the children of Israel..."}] };
  let bibleData = {};
  async function initBible(){
    const bookSel = $('bookSelect');
    bookSel.innerHTML = '';
    // try /bible/books.json (if uploaded)
    try{
      const r = await fetch('/bible/books.json');
      if(r.ok) bibleData = await r.json();
      else bibleData = SAMPLE;
    }catch(e){ bibleData = SAMPLE; }
    Object.keys(bibleData).forEach(b => { const o=create('option',{value:b},b); bookSel.appendChild(o); });
    bookSel.addEventListener('change', ()=> renderBible(bookSel.value));
    // select first
    const first = Object.keys(bibleData)[0];
    if(first){ bookSel.value = first; renderBible(first); }
    // search
    $('hymnVerseSearch').addEventListener('input', ()=> {
      const q = $('hymnVerseSearch').value.trim().toLowerCase();
      if(!q){ renderBible(bookSel.value); return; }
      searchBible(q);
    });
  }
  function renderBible(book){
    const verses = bibleData[book] || [];
    const cont = $('versesContainer'); cont.innerHTML = '';
    $('versesContainer').scrollTop = 0;
    verses.forEach(v => {
      const d = create('div',{},`<strong>${v.verse}.</strong> ${esc(v.text)}`);
      d.style.marginTop='8px';
      cont.appendChild(d);
    });
  }
  function searchBible(q){
    const cont = $('versesContainer'); cont.innerHTML = '';
    for(const b in bibleData){
      bibleData[b].forEach(v => {
        if(v.text.toLowerCase().includes(q) || v.verse.includes(q)){
          cont.appendChild(create('div',{},`<strong>${esc(b)} ${v.verse}</strong> â€” ${esc(v.text)}`));
        }
      });
    }
  }

  // ---------- Chat (WhatsApp-style) ----------
  // Data model:
  // - collections: conversations (id, title, members, lastMessage, lastUpdated)
  // - messages subcollection: { sender, text, ts, type:'text'|'image'|'audio', mediaURL, seenBy:[] }
  let currentConvoId = null;
  let messagesUnsub = null;
  async function subscribeConversations(){
    if(!auth.currentUser) return;
    const q = query(collection(db,'conversations'), where('members','array-contains', auth.currentUser.uid), orderBy('lastUpdated','desc'));
    const unsub = onSnapshot(q, snap => {
      const list = $('convoList'); list.innerHTML = '';
      snap.forEach(docSnap => {
        const d = docSnap.data(); const id = docSnap.id;
        const item = create('div', {className:'convo-item'}, `<div class="avatar">${(d.title||'U').slice(0,1)}</div><div style="flex:1"><div style="font-weight:800">${esc(d.title||'Direct')}</div><div class="muted small">${esc(d.lastMessage||'')}</div></div>`);
        item.onclick = ()=> openConversation(id, d);
        list.appendChild(item);
      });
    }, err=> console.error(err));
    window.convoUnsubGlobal = unsub;
    return unsub;
  }

  async function openConversation(id, data){
    currentConvoId = id;
    // unsubscribe previous
    if(messagesUnsub) messagesUnsub();
    // subscribe messages
    const msgsRef = collection(db,'conversations',id,'messages');
    const q = query(msgsRef, orderBy('ts'));
    messagesUnsub = onSnapshot(q, snap => {
      const win = $('messagesWindow'); win.innerHTML = '';
      snap.forEach(ms => {
        const m = ms.data();
        const cls = (m.sender === auth.currentUser.uid) ? 'bubble me' : 'bubble other';
        const node = create('div',{},`<div class="${cls}">${esc(m.text||'')} ${m.mediaURL?'<div><a href="'+m.mediaURL+'" target="_blank">[media]</a></div>':''}</div>`);
        win.appendChild(node);
      });
      win.scrollTop = win.scrollHeight;
    }, err=> console.error(err));
  }

  // send message
  $('sendMsgBtn').addEventListener('click', async ()=>{
    const txt = $('messageInput').value.trim();
    if(!txt && !$('fileUpload').files[0]) return;
    if(!currentConvoId){
      // create a default group (if none) â€” simple approach: create one conversation where current UID is member
      const title = 'Youth Group';
      const cRef = await addDoc(collection(db,'conversations'), { title, members:[auth.currentUser.uid], createdAt: serverTimestamp(), lastUpdated: serverTimestamp(), lastMessage: '', });
      currentConvoId = cRef.id;
      // subscribe newly created
      openConversation(currentConvoId, { title, members:[auth.currentUser.uid] });
    }
    // handle file attachment first if present
    const file = $('fileUpload').files[0];
    if(file){
      const path = `media/${currentConvoId}/${Date.now()}_${file.name}`;
      const r = sRef(storage, path);
      await uploadBytes(r, file);
      const url = await getDownloadURL(r);
      await addDoc(collection(db,'conversations',currentConvoId,'messages'), { sender: auth.currentUser.uid, type: file.type.startsWith('image') ? 'image' : 'audio', mediaURL: url, ts: serverTimestamp(), text: '' });
      await updateDoc(doc(db,'conversations',currentConvoId), { lastMessage: '[media]', lastUpdated: serverTimestamp() });
      $('fileUpload').value = '';
    }
    if(txt){
      await addDoc(collection(db,'conversations',currentConvoId,'messages'), { sender: auth.currentUser.uid, text: txt, type:'text', ts: serverTimestamp(), seenBy: [] });
      await updateDoc(doc(db,'conversations',currentConvoId), { lastMessage: txt, lastUpdated: serverTimestamp() });
      $('messageInput').value = '';
    }
  });

  // attach
  $('attachBtn').addEventListener('click', ()=> $('fileUpload').click());

  // ---------- Meeting embed (Google Meet fallback) ----------
  $('joinMeeting').addEventListener('click', openMeet);
  $('closeMeet').addEventListener('click', ()=> { $('meetModal').style.display='none'; $('meetBody').innerHTML=''; });

  function openMeet(){
    const meetURL = 'https://meet.google.com/' + (Math.random().toString(36).substring(2,9));
    // try embed iframe
    const iframe = document.createElement('iframe');
    iframe.src = meetURL;
    iframe.width='100%'; iframe.height='100%'; iframe.style.border='0';
    $('meetBody').innerHTML = '';
    $('meetBody').appendChild(iframe);
    $('meetModal').style.display = 'flex';
    setTimeout(()=> {
      // inform user if embed may be blocked
      const notice = create('div',{},`If the meeting does not load here, <a href="${meetURL}" target="_blank" style="color:#0066cc">open in Google Meet</a>.`);
      $('meetBody').appendChild(notice);
    }, 1200);
  }

  // ---------- Quick open helpers ----------
  $('openBible').addEventListener('click', ()=> { $('bibleSection').classList.remove('hidden'); window.scrollTo({top:0,behavior:'smooth'}); initBible(); });
  $('openChat').addEventListener('click', ()=> { $('chatSection').classList.remove('hidden'); subscribeConversations(); });

  // ---------- Initial render (before login) ----------
  renderLeaders();
  renderEvents();
  setFunFact();

  // ---------- End of module ----------
  </script>
</body>
</html>

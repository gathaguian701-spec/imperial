<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>IMPERIAL TECHUB</title>
<link rel="icon" href="data:image/svg+xml;base64,PHN2ZyBmaWxsPSIjMDAyMzY2IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHRleHQgeD0iNCIgeT0iMjQiIGZvbnQtc2l6ZT0iMjQiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmaWxsPSJ3aGl0ZSI+SVQ8L3RleHQ+PC9zdmc+" />

<style>
  :root{
    --royal:#002366; --accent:#00b4ff; --muted: rgba(230,230,230,0.85);
    --card: rgba(255,255,255,0.04); --glass: rgba(255,255,255,0.03);
    --site-max:1100px;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family: Inter, "Segoe UI", Roboto, system-ui, -apple-system, "Helvetica Neue", Arial;
    background: linear-gradient(135deg,var(--royal), #003b99);
    color:#fff; -webkit-font-smoothing:antialiased;
  }
  main{max-width:var(--site-max);margin:20px auto;padding:0 16px;}

  /* Intro - EXACT 10s fade request was earlier 10s but you later asked 5s; we use 5s */
  #intro{
    position:fixed; inset:0; display:flex; flex-direction:column; justify-content:center; align-items:center;
    background:#001F4D; z-index:9999; pointer-events:none; animation:introFade 5s linear forwards;
  }
  @keyframes introFade{0%{opacity:1}95%{opacity:1}100%{opacity:0;visibility:hidden}}
  #intro h1{font-size:clamp(2rem,6vw,4rem); color:#cfe9ff; font-weight:900; letter-spacing:2px; margin-bottom:12px;}
  .pulse{width:18px;height:18px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 rgba(0,180,255,0.4);animation:pulse 1.5s infinite}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(0,180,255,.45)}60%{box-shadow:0 0 0 26px rgba(0,180,255,0)}100%{box-shadow:0 0 0 0 rgba(0,180,255,0)}}

  #site{opacity:0;transition:opacity .35s ease-in-out}

  /* Top nav */
  .topbar{position:sticky;top:0;background:rgba(0,0,0,0.12);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,0.03);z-index:900}
  .nav-inner{max-width:var(--site-max);margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:10px 16px;gap:12px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#62d3ff);display:flex;align-items:center;justify-content:center;color:#012;font-weight:900}
  .nav-links{display:flex;gap:8px;flex-wrap:wrap}
  .nav-btn{background:transparent;border:0;color:#fff;padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer}
  .nav-btn.active{color:var(--accent);background:rgba(255,255,255,0.03)}

  /* Pages */
  section.page{display:none;opacity:0;transform:translateY(6px);transition:opacity .32s,transform .32s}
  section.page.active{display:block;opacity:1;transform:none}

  .card{background:var(--card);border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 26px rgba(0,0,0,0.35)}
  .center{text-align:center}
  h2{margin-bottom:8px}

  /* Events */
  .events-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px;margin-top:12px}
  .event-qty{font-weight:900;font-family:ui-monospace,monospace;font-size:1.25rem;color:var(--accent);margin-top:8px}
  .event-meta{color:var(--muted);font-size:.95rem;margin-top:8px}

  /* Leaders */
  .leaders-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
  .leader-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:10px}
  .contact-actions{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
  .wa-btn{background:linear-gradient(90deg,#25D366,#128C7E);color:#012;padding:8px 10px;border-radius:8px;font-weight:800;text-decoration:none}
  .call-btn{background:linear-gradient(90deg,#ffd54f,#ffb300);color:#012;padding:8px 10px;border-radius:8px;font-weight:700;text-decoration:none}

  /* Hymnbook */
  .hymn-search{display:flex;gap:8px;align-items:center;margin-bottom:12px}
  .hymn-search input{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--white)}
  .hymn-list{display:flex;flex-direction:column;gap:8px;max-height:420px;overflow:auto}
  .hymn-item{padding:12px;border-radius:10px;background:var(--glass);cursor:pointer}
  .hymn-lyrics{display:none;color:#e9f3ff;margin-top:8px;white-space:pre-line}

  /* Membership */
  .membership-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-top:12px}
  .membership-card{padding:16px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));text-align:center}
  .buy-btn{padding:10px 14px;border-radius:8px;border:0;background:var(--accent);color:#012;font-weight:800;cursor:pointer}

  /* Modal (Jitsi & MiniPay & generic) */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;z-index:10000}
  .modal.show{display:flex}
  .modal-content{width:95%;max-width:1000px;background:#fff;border-radius:10px;overflow:hidden;color:#012}
  .modal-head{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:var(--royal);color:#fff}
  .modal-body{padding:0}
  .modal-iframe{width:100%;height:640px;border:0;display:block}
  .modal-close{background:#ff7676;border:0;color:#012;padding:8px 12px;border-radius:8px;cursor:pointer}

  /* Reader (Bible) */
  .reader { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding: 24px; border-radius:12px; margin-top:12px; color:#eaf6ff; }
  .reader .book-title{font-size:1.2rem;font-weight:900;margin-bottom:8px}
  .reader .chapter-title{font-size:1rem;font-weight:800;color:var(--muted);margin-bottom:12px}
  .reader .verse { margin:8px 0; font-size:1.05rem; line-height:1.6; color:#f7fbff; }
  .verse .num { font-weight:800; color:var(--accent); margin-right:8px; }
  .reader-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
  .select, .search { padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06); background:transparent; color:inherit }

  /* Light theme overrides */
  body.light-theme { background: linear-gradient(135deg,#f7fbff,#eaf6ff); color:#002246 }
  body.light-theme .card { background:#fff; color:#002246 }
  body.light-theme .reader { color:#0b2340 }
  .search-result { padding:10px;border-radius:8px;background:rgba(255,255,255,0.03); margin-bottom:8px }
  .search-result .meta { color:var(--muted); font-size:.95rem; margin-bottom:6px }

  /* Messaging UI small tweaks */
  .mess-user { padding:8px;border-radius:6px;margin-bottom:6px;background:rgba(255,255,255,0.02); }
  .dm-btn { padding:6px 8px;border-radius:6px;background:var(--accent);color:#012;border:0;cursor:pointer }

  footer{margin-top:22px;text-align:center;color:rgba(255,255,255,0.95);padding-bottom:28px}
  @media (max-width:760px){ .modal-iframe{height:420px} .reader .verse{font-size:1rem} }
</style>
</head>
<body>

<!-- INTRO -->
<div id="intro" aria-hidden="true">
  <h1>IMPERIAL TECHUB</h1>
  <div class="pulse"></div>
</div>

<!-- SITE -->
<div id="site" aria-hidden="true">
  <header class="topbar">
    <div class="nav-inner">
      <div class="brand"><div class="logo">IT</div><div class="title">IMPERIAL TECHUB</div></div>
      <nav class="nav-links" role="navigation" aria-label="Main">
        <button class="nav-btn active" data-page="home">HOME</button>
        <button class="nav-btn" data-page="events">EVENTS</button>
        <button class="nav-btn" data-page="announcements">ANNOUNCEMENTS</button>
        <button class="nav-btn" data-page="calendar">CALENDAR</button>
        <button class="nav-btn" data-page="leaders">LEADERS</button>
        <button class="nav-btn" data-page="hymnbook">HYMNBOOK</button>
        <button class="nav-btn" data-page="membership">MEMBERSHIP</button>
        <button class="nav-btn" data-page="video">VIDEO FELLOWSHIP</button>
        <button class="nav-btn" data-page="bible">BIBLE</button>
        <button class="nav-btn" data-page="messaging">MESSAGING</button>
      </nav>
    </div>
  </header>

  <main>
    <!-- HOME -->
    <section id="home" class="page active">
      <div class="card center" style="max-width:900px;margin:18px auto">
        <h2>ðŸ’¡ Fun Fact</h2>
        <p id="funFact" style="font-size:1.05rem"></p>
        <small style="color:var(--muted)">New fact daily</small>
      </div>
    </section>

    <!-- EVENTS -->
    <section id="events" class="page">
      <div class="card">
        <h2>ðŸ“… Upcoming Events</h2>
        <div id="eventsGrid" style="margin-top:12px" class="events-grid"></div>
      </div>
    </section>

    <!-- ANNOUNCEMENTS -->
    <section id="announcements" class="page">
      <div class="card">
        <h2>ðŸ“£ Announcements</h2>
        <div style="margin-top:12px">
          <div class="card" style="margin-bottom:12px"><h3>PCEA NGORANO PARISH YOUTH RALLY</h3><p><strong>Sunday, 16th November 2025 â€” PCEA Chieni Church</strong></p><p>All youths are encouraged to attend for fellowship, worship, and spiritual growth.</p></div>
          <div class="card"><h3>PRESBYTERY YOUTH CONVENTION</h3><p><strong>Tuesday, 2nd December â€“ Saturday, 6th December 2025</strong></p><p>Charges: Ksh 1,500 per person (payable in instalments).</p></div>
        </div>
      </div>
    </section>

    <!-- CALENDAR -->
    <section id="calendar" class="page">
      <div class="card">
        <h2>ðŸ—“ Calendar</h2>
        <ul id="calendarList" style="margin-top:12px;color:var(--muted)"></ul>
      </div>
    </section>

    <!-- LEADERS -->
    <section id="leaders" class="page">
      <div class="card">
        <h2>ðŸ‘¥ Leaders & Contacts</h2>
        <div class="leaders-grid" id="leadersGrid" style="margin-top:12px"></div>
      </div>
    </section>

    <!-- HYMNBOOK -->
    <section id="hymnbook" class="page">
      <div class="card">
        <h2>ðŸŽµ Hymnbook</h2>
        <div style="margin-top:12px" class="hymn-search">
          <input id="hymnQuery" placeholder="Search hymn by title or any line..." class="select" />
          <button id="clearHymn" class="select">Clear</button>
        </div>
        <div id="hymnList" class="hymn-list"></div>
      </div>
    </section>

    <!-- MEMBERSHIP -->
    <section id="membership" class="page">
      <div class="card">
        <h2>ðŸ’› Support & Membership</h2>
        <p style="color:var(--muted)">Choose a tier to support youth activities. Payments via MiniPay.</p>
        <div style="margin-top:12px" class="membership-grid">
          <div class="membership-card"><h3>Gold</h3><p><strong>Ksh 300 / month</strong></p><button class="buy-btn" data-plan="Gold" data-amount="300">Buy Gold</button></div>
          <div class="membership-card"><h3>Platinum</h3><p><strong>Ksh 500 / month</strong></p><button class="buy-btn" data-plan="Platinum" data-amount="500">Buy Platinum</button></div>
          <div class="membership-card"><h3>Diamond</h3><p><strong>Ksh 1000 / month</strong></p><button class="buy-btn" data-plan="Diamond" data-amount="1000">Buy Diamond</button></div>
        </div>
      </div>
    </section>

    <!-- VIDEO FELLOWSHIP -->
    <section id="video" class="page">
      <div class="card">
        <h2>ðŸŽ¥ Video Fellowship</h2>
        <p style="color:var(--muted)">Click Join Meeting to open a fresh meeting in a modal. Rooms are unique per session.</p>
        <div style="margin-top:12px"><button id="joinVideoBtn" class="buy-btn" style="background:var(--accent);color:#012">Join Meeting</button><button id="leaveVideoBtn" class="buy-btn" style="display:none;background:#ff7676;color:#012">Leave</button></div>
      </div>
    </section>

    <!-- BIBLE (Light/Dark + Full Search) -->
    <section id="bible" class="page">
      <div class="card">
        <div class="reader-controls" style="margin-bottom:12px">
          <select id="bookSelect" class="select"></select>
          <select id="chapterSelect" class="select"></select>
          <input id="verseSearch" class="search" placeholder="Search inside current chapter..." style="flex:1" />
          <button id="searchBibleBtn" class="select">Search Scripture (entire Bible)</button>
          <button id="toggleTheme" class="select" style="margin-left:auto">Toggle Light/Dark</button>
        </div>

        <div id="reader" class="reader">
          <div class="book-title" id="bookTitle">Genesis</div>
          <div class="chapter-title" id="chapterTitle">Chapter 1</div>
          <div id="versesContainer"></div>
        </div>

        <div id="searchResults" style="margin-top:14px"></div>
        <div id="searchStatus" style="margin-top:8px;color:var(--muted)"></div>
      </div>
    </section>

    <!-- MESSAGING -->
    <section id="messaging" class="page">
      <div class="card">
        <h2>ðŸ’¬ Messaging</h2>
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:10px">
          <div><strong id="meName">Not signed in</strong></div>
          <div style="margin-left:auto">
            <button id="btnSignOut" class="select" style="display:none">Sign out</button>
          </div>
        </div>

        <div style="display:flex;gap:12px">
          <div style="width:320px">
            <div style="margin-bottom:8px"><input id="displayNameInput" placeholder="Set display name" class="select" style="width:100%"></div>
            <div style="margin-bottom:8px">
              <button id="btnSaveProfile" class="select">Save profile</button>
              <button id="btnRefreshUsers" class="select">Refresh users</button>
            </div>
            <div id="usersList" style="border-radius:8px;padding:8px;background:var(--glass);max-height:400px;overflow:auto"></div>
            <div style="margin-top:8px">
              <input id="groupName" placeholder="New group name" class="select" style="width:60%"/>
              <button id="btnCreateGroup" class="select">Create Group</button>
            </div>
          </div>

          <div style="flex:1;display:flex;flex-direction:column">
            <div id="chatMeta" style="margin-bottom:8px;color:var(--muted)"></div>
            <div id="chatWindow" style="flex:1;border-radius:8px;padding:12px;background:var(--glass);overflow:auto;min-height:240px"></div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <input id="msgInput" placeholder="Type a message..." class="select" style="flex:1" />
              <button id="btnSend" class="select">Send</button>
            </div>
            <div id="chatStatus" style="color:var(--muted);margin-top:6px"></div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <footer>
    PROUDLY CREATED BY <strong>IAN GATHAGU</strong> â€” v1.3.5
  </footer>
</div>

<!-- MODALS -->
<div id="jitsiModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <div class="modal-head"><div>Youth Fellowship Meeting</div><div><button id="jitsiClose" class="modal-close">Leave</button></div></div>
    <div class="modal-body" id="jitsiBody"></div>
  </div>
</div>

<div id="mpModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <div class="modal-head"><div>Complete Payment</div><div><button id="mpClose" class="modal-close">Close</button></div></div>
    <div class="modal-body">
      <iframe id="mpIframe" src="" class="modal-iframe"></iframe>
    </div>
  </div>
</div>

<!-- FIREBASE (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
/* =========================
   Firebase initialization (using config you provided)
   ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyBNnNfTHE6h-hnTW6LAixiAJ7X--HMTMA0",
  authDomain: "imperial-techub.firebaseapp.com",
  projectId: "imperial-techub",
  storageBucket: "imperial-techub.firebasestorage.app",
  messagingSenderId: "361070773876",
  appId: "1:361070773876:web:ce41754e58a058e827f321"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* =========================
   SITE BOOT + INTRO removal (force at 5s)
   ========================= */
(function(){
  const intro = document.getElementById('intro');
  const site = document.getElementById('site');

  setTimeout(() => {
    if(intro && intro.style.display !== 'none'){
      intro.style.display = 'none';
      site.style.opacity = '1';
      initSite();
    }
  }, 5000);

  intro.addEventListener('animationend', () => {
    intro.style.display = 'none';
    site.style.opacity = '1';
    initSite();
  });
})();

/* =========================
   Global init
   ========================= */
function initSite(){
  bindNav();
  setFunFact();
  initEvents();
  renderCalendar();
  renderLeaders();
  loadHymns();
  bindMembershipButtons();
  bindJitsi();
  bindBible();
  bindMessaging(); // starts Firebase anonymous + keys etc.
  preloadScript('https://meet.jit.si/external_api.js');
}

/* =========================
   NAV
   ========================= */
function bindNav(){
  document.querySelectorAll('.nav-btn').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      showPage(b.dataset.page);
    });
  });
}
function showPage(page){
  document.querySelectorAll('section.page').forEach(s=> s.classList.toggle('active', s.id===page));
  window.scrollTo({top:0,behavior:'smooth'});
}

/* =========================
   FUN FACT (daily)
   ========================= */
function setFunFact(){
  const facts = [
    "The Bible is the most translated book in the world.",
    "Jesus wept. (John 11:35)",
    "'Fear not' is written many times in scripture as encouragement.",
    "Psalm 117 is the shortest chapter."
  ];
  const today = new Date().toDateString();
  const saved = JSON.parse(localStorage.getItem('it_funFact') || 'null');
  if(!saved || saved.date !== today){
    const f = facts[Math.floor(Math.random()*facts.length)];
    localStorage.setItem('it_funFact', JSON.stringify({date:today,fact:f}));
    document.getElementById('funFact').innerText = f;
  } else {
    document.getElementById('funFact').innerText = saved.fact;
  }
}

/* =========================
   EVENTS & COUNTDOWNS
   ========================= */
const EVENTS = [
  { id:'youth-rally', title:'Youth Rally â€” PCEA Chieni Church', start:'2025-11-16T09:00:00', end:'2025-11-16T17:00:00', location:'PCEA Chieni Church' },
  { id:'presbytery-convention', title:'Presbytery Youth Convention', start:'2025-12-02T09:00:00', end:'2025-12-06T18:00:00', location:'Presbytery Venue' },
  { id:'christmas', title:'Christmas Day', start:'2025-12-25T00:00:00', end:'2025-12-25T23:59:59', location:'All Parishes' },
  { id:'new-year', title:"New Year's Day", start:'2026-01-01T00:00:00', end:'2026-01-01T23:59:59', location:'All Parishes' }
];
let countdownInterval = null;
function initEvents(){
  EVENTS.forEach(e=>{ e.startDate=new Date(e.start); e.endDate=new Date(e.end); });
  renderEvents();
  if(countdownInterval) clearInterval(countdownInterval);
  countdownInterval = setInterval(updateCountdowns,1000);
  updateCountdowns();
}
function renderEvents(){
  const grid = document.getElementById('eventsGrid'); grid.innerHTML='';
  const now = new Date();
  const mapped = EVENTS.map(e=>{
    let diff;
    if(now>e.endDate) diff = Infinity;
    else if(now>=e.startDate && now<=e.endDate) diff = 0;
    else diff = e.startDate - now;
    return {...e,diff};
  }).sort((a,b)=>a.diff-b.diff);
  mapped.forEach(e=>{
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `<h3 style="margin:0">${e.title}</h3><div style="color:var(--muted);margin-top:8px">Location: ${e.location}</div>`;
    grid.appendChild(card);
  });
}
function updateCountdowns(){
  const now = new Date();
  EVENTS.forEach(e=>{
    const el = document.getElementById('cd-'+e.id); if(!el) return;
    if(now>e.endDate){ el.innerText='Event Passed'; el.style.color='rgba(255,255,255,0.6)'; return; }
    if(now>=e.startDate && now<=e.endDate){ el.innerText='Now Happening!'; el.style.color='#ffdd57'; return; }
    let diff = e.startDate - now;
    const days=Math.floor(diff/(24*60*60*1000)); diff-=days*(24*60*60*1000);
    const hours=Math.floor(diff/(60*60*1000)); diff-=hours*(60*60*1000);
    const mins=Math.floor(diff/(60*1000)); diff-=mins*(60*1000);
    const secs=Math.floor(diff/1000);
    el.innerText = `${pad(days)}d ${pad(hours)}h ${pad(mins)}m ${pad(secs)}s`;
  });
}
function formatDateRange(s,e){ const opts={year:'numeric',month:'short',day:'numeric'}; if(s.toDateString()===e.toDateString()) return s.toLocaleDateString(undefined,opts); return s.toLocaleDateString(undefined,opts)+' â€” '+e.toLocaleDateString(undefined,opts); }
function pad(n){ return String(n).padStart(2,'0'); }

/* =========================
   CALENDAR
   ========================= */
function renderCalendar(){
  const ul = document.getElementById('calendarList'); ul.innerHTML='';
  EVENTS.forEach(e=>{ const li=document.createElement('li'); li.innerHTML=`<strong style="color:#fff">${e.title}</strong> â€” <span style="color:var(--muted)">${e.startDate.toDateString()}</span>`; ul.appendChild(li); });
}

/* =========================
   LEADERS
   ========================= */
function renderLeaders(){
  const leaders = [
    { office:"Zachary's Office", name:"Zachary Gikonyo", role:"Chairperson", phone:"+254742892647" },
    { office:"Dalson's Office", name:"Dalson Maina", role:"Vice Chairperson", phone:"+254714003648" },
    { office:"Ian's Office", name:"Ian Gathagu", role:"Secretary", phone:"+254718357417" },
    { office:"Lydia's Office", name:"Lydia Wamuyu", role:"Vice Secretary", phone:"+254110867929" },
    { office:"Winnie's Office", name:"Winnie Maundu", role:"Treasurer", phone:"+254713285534" }
  ];
  const grid=document.getElementById('leadersGrid'); grid.innerHTML='';
  leaders.forEach(ld=>{
    const el=document.createElement('div'); el.className='leader-card'; el.innerHTML=`<div style="font-weight:900">${ld.office}</div><div style="color:var(--muted)">${ld.name} â€” ${ld.role}</div><div class="contact-actions"><a class="wa-btn" href="https://wa.me/${ld.phone.replace(/\D/g,'')}" target="_blank">WhatsApp</a> <a class="call-btn" href="tel:${ld.phone.replace(/\D/g,'')}">Call</a> <div style="color:var(--muted);padding-left:6px">${ld.phone}</div></div>`; grid.appendChild(el);
  });
}

/* =========================
   HYMNBOOK
   ========================= */
const HYMNS = [
  { title: "Amazing Grace", lyrics: "Amazing grace! How sweet the sound\nThat saved a wretch like me." },
  { title: "How Great Thou Art", lyrics: "O Lord my God, when I in awesome wonder..." },
  { title: "To God Be the Glory", lyrics: "To God be the glory, great things He hath done." }
];
function loadHymns(){ renderHymnList(''); const q=document.getElementById('hymnQuery'); const c=document.getElementById('clearHymn'); if(q) q.addEventListener('input', ()=>renderHymnList(q.value)); if(c) c.addEventListener('click', ()=>{ q.value=''; renderHymnList(''); }); }
function renderHymnList(filter){ const list=document.getElementById('hymnList'); list.innerHTML=''; const f=(filter||'').trim().toLowerCase(); const filtered=HYMNS.filter(h=>!f||h.title.toLowerCase().includes(f)||h.lyrics.toLowerCase().includes(f)); if(!filtered.length){ list.innerHTML='<div style="color:var(--muted);padding:8px">No hymns found.</div>'; return; } filtered.forEach(h=>{ const item=document.createElement('div'); item.className='hymn-item'; item.innerHTML=`<div style="font-weight:800">${h.title}</div><div class="hymn-lyrics">${escapeHtml(h.lyrics)}</div>`; item.addEventListener('click', ()=>{ document.querySelectorAll('.hymn-item .hymn-lyrics').forEach(x=>x.style.display='none'); const lyrics=item.querySelector('.hymn-lyrics'); lyrics.style.display = lyrics.style.display==='block' ? 'none' : 'block'; }); list.appendChild(item); }); }
function escapeHtml(txt){ return String(txt).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>'); }

/* =========================
   MEMBERSHIP / MiniPay
   ========================= */
function bindMembershipButtons(){
  const MERCHANT = encodeURIComponent('+254718357417');
  const BASE = 'https://checkout.minipay.co/checkout';
  document.querySelectorAll('.buy-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const plan = btn.dataset.plan || btn.getAttribute('data-plan') || btn.textContent.trim();
      const amount = btn.dataset.amount || btn.getAttribute('data-amount') || '100';
      const ref = makeRef(plan, amount);
      const params = new URLSearchParams({ merchant: MERCHANT, amount: amount, currency:'KES', reference: ref, description:`${plan} membership` });
      const url = `${BASE}?${params.toString()}`;
      document.getElementById('mpIframe').src = url;
      document.getElementById('mpModal').classList.add('show');
      // fallback to open new tab if embed blocked
      setTimeout(()=>{ window.open(url,'_blank'); }, 3000);
    });
  });
  const mpClose = document.getElementById('mpClose');
  if(mpClose) mpClose.addEventListener('click', ()=>{ document.getElementById('mpIframe').src=''; document.getElementById('mpModal').classList.remove('show'); });
}
function makeRef(p,a){ const n=new Date(); return `IT-${p}-${n.getFullYear()}${String(n.getMonth()+1).padStart(2,'0')}${String(n.getDate()).padStart(2,'0')}-${n.getHours()}${n.getMinutes()}${n.getSeconds()}-${Math.floor(Math.random()*9000)+1000}`; }

/* =========================
   JITSI Video binding
   ========================= */
function bindJitsi(){
  const join = document.getElementById('joinVideoBtn'), leave=document.getElementById('leaveVideoBtn'), modal=document.getElementById('jitsiModal'), body=document.getElementById('jitsiBody'), close=document.getElementById('jitsiClose');
  let api=null,scriptLoaded=false;
  join.addEventListener('click', ()=>{
    if(api) return;
    loadJitsi(()=> {
      const room = makeRoom();
      const node = document.createElement('div'); node.id='jitsi-'+Date.now(); node.style.width='100%'; node.style.height='640px'; body.appendChild(node);
      try {
        api = new JitsiMeetExternalAPI('meet.jit.si',{ roomName: room, parentNode: node, width:'100%', height:640, configOverwrite:{prejoinPageEnabled:false}, interfaceConfigOverwrite:{TOOLBAR_BUTTONS:['microphone','camera','desktop','fullscreen','hangup','chat','participants-pane']} });
        modal.classList.add('show'); join.style.display='none'; leave.style.display='inline-block';
        api.addEventListener('videoConferenceLeft', cleanup);
      } catch(e){ console.error(e); alert('Could not start meeting.'); node.remove(); api=null; }
    });
  });
  leave.addEventListener('click', cleanup); close.addEventListener('click', cleanup);
  function cleanup(){ try{ if(api) api.dispose(); }catch(e){} api=null; body.innerHTML=''; modal.classList.remove('show'); join.style.display='inline-block'; leave.style.display='none'; window.scrollTo({top:0,behavior:'smooth'}); }
  function loadJitsi(cb){ if(scriptLoaded){ cb(); return; } const s=document.createElement('script'); s.src='https://meet.jit.si/external_api.js'; s.async=true; s.onload=()=>{ scriptLoaded=true; cb(); }; s.onerror=()=>{ alert('Unable to load video service'); }; document.head.appendChild(s); }
  function makeRoom(){ const now=new Date(); const Y=now.getFullYear(),M=String(now.getMonth()+1).padStart(2,'0'),D=String(now.getDate()).padStart(2,'0'),h=String(now.getHours()).padStart(2,'0'),m=String(now.getMinutes()).padStart(2,'0'),s=String(now.getSeconds()).padStart(2,'0'); return `PCEA-Center-Youth-${Y}${M}${D}-${h}${m}${s}-${Math.floor(Math.random()*9000)+1000}`; }
}

/* =========================
   Preload helper
   ========================= */
function preloadScript(src){ const s=document.createElement('script'); s.src=src; s.async=true; s.onload=()=>console.log('preloaded',src); s.onerror=()=>console.log('failed preload',src); document.head.appendChild(s); }

/* =========================
   BIBLE READER (Light/Dark + Full Search)
   - Reads files from /bible/{Book}.txt
   - Make sure your repo has /bible/Genesis.txt etc.
   ========================= */
const BOOKS = [
  "Genesis","Exodus","Leviticus","Numbers","Deuteronomy","Joshua","Judges","Ruth",
  "1 Samuel","2 Samuel","1 Kings","2 Kings","1 Chronicles","2 Chronicles","Ezra","Nehemiah",
  "Esther","Job","Psalms","Proverbs","Ecclesiastes","Song of Solomon","Isaiah","Jeremiah",
  "Lamentations","Ezekiel","Daniel","Hosea","Joel","Amos","Obadiah","Jonah",
  "Micah","Nahum","Habakkuk","Zephaniah","Haggai","Zechariah","Malachi",
  "Matthew","Mark","Luke","John","Acts","Romans","1 Corinthians","2 Corinthians",
  "Galatians","Ephesians","Philippians","Colossians","1 Thessalonians","2 Thessalonians",
  "1 Timothy","2 Timothy","Titus","Philemon","Hebrews","James","1 Peter","2 Peter",
  "1 John","2 John","3 John","Jude","Revelation"
];
const BIBLE_BASE = '/bible/';
const bookSelect = document.getElementById('bookSelect');
const chapterSelect = document.getElementById('chapterSelect');
const bookTitle = document.getElementById('bookTitle');
const chapterTitle = document.getElementById('chapterTitle');
const versesContainer = document.getElementById('versesContainer');
const verseSearch = document.getElementById('verseSearch');
const searchBibleBtn = document.getElementById('searchBibleBtn');
const searchResults = document.getElementById('searchResults');
const searchStatus = document.getElementById('searchStatus');
const toggleThemeBtn = document.getElementById('toggleTheme');

let bookCache = {}; parsedCache = {};
function bindBible(){
  BOOKS.forEach(b => { const opt = document.createElement('option'); opt.value = b; opt.textContent = b; bookSelect.appendChild(opt); });
  const theme = localStorage.getItem('it_theme') || 'dark';
  setTheme(theme);

  bookSelect.addEventListener('change', async () => { await ensureBookLoaded(bookSelect.value); populateChapters(bookSelect.value); chapterSelect.selectedIndex = 0; chapterSelect.dispatchEvent(new Event('change')); });
  chapterSelect.addEventListener('change', () => { renderChapter(bookSelect.value, chapterSelect.value); });
  verseSearch.addEventListener('input', () => { const q = verseSearch.value.trim().toLowerCase(); document.querySelectorAll('#versesContainer .verse').forEach(v => { v.style.display = (q === '' || v.innerText.toLowerCase().includes(q)) ? '' : 'none'; }); });
  searchBibleBtn.addEventListener('click', ()=>{ const q = verseSearch.value.trim(); if(!q) return alert('Type a search term first'); searchWholeBible(q); });
  toggleThemeBtn.addEventListener('click', ()=>{ const current = document.body.classList.contains('light-theme') ? 'light' : 'dark'; setTheme(current === 'light' ? 'dark' : 'light'); });

  // preload Genesis for immediate view (if file exists)
  (async ()=>{ try{ await ensureBookLoaded('Genesis'); populateChapters('Genesis'); chapterSelect.value='1'; chapterSelect.dispatchEvent(new Event('change')); }catch(e){ console.warn('Genesis load failed',e); } })();
}

function setTheme(mode){ if(mode === 'light'){ document.body.classList.add('light-theme'); localStorage.setItem('it_theme','light'); toggleThemeBtn.innerText='Dark Mode'; } else { document.body.classList.remove('light-theme'); localStorage.setItem('it_theme','dark'); toggleThemeBtn.innerText='Light Mode'; } }

async function ensureBookLoaded(book){
  if(bookCache[book]) return;
  const filename = book + '.txt';
  searchStatus.innerText = `Loading ${book}...`;
  try {
    const res = await fetch(BIBLE_BASE + filename);
    if(!res.ok) throw new Error('Book file not found: ' + filename);
    const txt = await res.text();
    bookCache[book] = txt;
    parsedCache[book] = parseBookToChapters(txt);
  } catch(err){
    console.error(err);
    searchStatus.innerText = `Failed loading ${book}. Check /bible/${filename}`;
    parsedCache[book] = {};
  } finally {
    setTimeout(()=>{ searchStatus.innerText = ''; }, 800);
  }
}

function parseBookToChapters(txt){
  const byLines = txt.replace(/\r\n/g,'\n').split('\n');
  let chapters = {};
  const chapterIndices = [];
  for(let i=0;i<byLines.length;i++){
    if(/^\s*(CHAPTER|Chapter)\s+\d+/i.test(byLines[i])) chapterIndices.push(i);
  }
  if(chapterIndices.length > 0){
    for(let c=0;c<chapterIndices.length;c++){
      const start = chapterIndices[c];
      const end = (c+1<chapterIndices.length) ? chapterIndices[c+1] : byLines.length;
      const m = byLines[start].match(/(\d+)/);
      const chapNum = m ? m[1] : String(c+1);
      const body = byLines.slice(start+1,end).join('\n').trim();
      chapters[chapNum] = splitVerses(body);
    }
    return chapters;
  }

  const fullText = byLines.join('\n').trim();
  const versesDetected = byLines.find(l=>l && /^\s*\d+\s+/.test(l));
  if(versesDetected){
    chapters['1'] = splitVerses(fullText);
    return chapters;
  }

  const words = fullText.split(/\s+/);
  const chunkSize = 2000;
  let chapterCount = Math.ceil(words.length / chunkSize);
  for(let i=0;i<chapterCount;i++){
    const chunkWords = words.slice(i*chunkSize, (i+1)*chunkSize);
    chapters[String(i+1)] = [{verse:'1', text: chunkWords.join(' ')}];
  }
  return chapters;
}

function splitVerses(body){
  const pieces = [];
  const txt = body.replace(/\r\n/g,'\n');
  const verseRegex = /(^|\n)\s*(\d+)[\).\:]?\s*/g;
  let match; const indices=[];
  while((match = verseRegex.exec(txt)) !== null){ indices.push({index: match.index + match[1].length, num: match[2]}); }
  if(indices.length > 0){
    for(let i=0;i<indices.length;i++){
      const start = indices[i].index;
      const num = indices[i].num;
      const end = (i+1<indices.length) ? indices[i+1].index : txt.length;
      const verseText = txt.slice(start + String(num).length).replace(/^[\s\)\.:-]*/,'').slice(0, end - (start + String(num).length)).trim();
      pieces.push({verse: num, text: verseText});
    }
    return pieces;
  }
  const paras = txt.split(/\n\s*\n/).filter(Boolean);
  if(paras.length > 1) return paras.map((p, idx)=>({verse: String(idx+1), text: p.trim()}));
  return [{verse:'1', text: txt.trim()}];
}

function populateChapters(book){
  const chapters = parsedCache[book] ? Object.keys(parsedCache[book]) : [];
  chapterSelect.innerHTML = '';
  chapters.forEach(c=>{ const o = document.createElement('option'); o.value = c; o.textContent = 'Chapter ' + c; chapterSelect.appendChild(o); });
}

function renderChapter(book, chapter){
  const ch = (parsedCache[book] && parsedCache[book][String(chapter)]) || [];
  bookTitle.innerText = book;
  chapterTitle.innerText = 'Chapter ' + chapter;
  versesContainer.innerHTML = '';
  ch.forEach(v=>{
    const d = document.createElement('div');
    d.className='verse';
    d.innerHTML = `<span class="num">${v.verse}.</span> ${escapeHtml(v.text)}`;
    versesContainer.appendChild(d);
  });
  searchResults.innerHTML = '';
}

async function searchWholeBible(query){
  query = String(query || '').trim();
  if(!query) return;
  searchResults.innerHTML = '';
  searchStatus.innerText = 'Searching entire Bible...';
  const qLower = query.toLowerCase();
  const matches = [];
  for(let i=0;i<BOOKS.length;i++){
    const book = BOOKS[i];
    if(!bookCache[book]) {
      try { await ensureBookLoaded(book); } catch(e){ console.warn('Failed loading', book); }
    }
    const chapters = parsedCache[book] || {};
    for(const chNum of Object.keys(chapters)){
      const verses = chapters[chNum];
      for(const v of verses){
        if(v.text && v.text.toLowerCase().includes(qLower)){
          const idx = v.text.toLowerCase().indexOf(qLower);
          const start = Math.max(0, idx - 40);
          const end = Math.min(v.text.length, idx + qLower.length + 40);
          const snippet = (start>0 ? '...':'') + v.text.slice(start,end).replace(new RegExp(escapeRegExp(query),'ig'), (m)=>`<strong style="background:var(--accent);color:#012;padding:0 2px">${m}</strong>`) + (end < v.text.length ? '...':'');
          matches.push({book, chapter: chNum, verse: v.verse, snippet});
        }
      }
    }
    searchStatus.innerText = `Searching: ${book} (${i+1}/${BOOKS.length}) â€” found ${matches.length} matches`;
    await new Promise(r=>setTimeout(r,10));
  }

  searchStatus.innerText = `Search complete â€” ${matches.length} matches`;
  if(matches.length===0){ searchResults.innerHTML = `<div class="search-result">No results for "<strong>${escapeHtml(query)}</strong>".</div>`; return; }

  const grouped = {};
  matches.forEach(m=>{ const key = `${m.book}__${m.chapter}`; (grouped[key] = grouped[key]||{book:m.book,chapter:m.chapter,items:[]}).items.push(m); });

  const frag = document.createDocumentFragment();
  Object.values(grouped).forEach(g=>{
    const box = document.createElement('div'); box.className = 'search-result';
    const meta = document.createElement('div'); meta.className='meta'; meta.innerHTML = `<strong>${escapeHtml(g.book)}</strong> â€” Chapter ${g.chapter} â€” ${g.items.length} match(es)`;
    box.appendChild(meta);
    g.items.forEach(it => {
      const sn = document.createElement('div'); sn.className='match-snippet'; sn.innerHTML = `<div style="margin-bottom:6px">${it.snippet}</div><div style="color:var(--muted);font-size:.95rem">${it.book} ${it.chapter}:${it.verse} <button data-book="${it.book}" data-ch="${it.chapter}" data-v="${it.verse}" class="select go-to">Open</button></div>`;
      box.appendChild(sn);
    });
    frag.appendChild(box);
  });
  searchResults.innerHTML = '';
  searchResults.appendChild(frag);

  document.querySelectorAll('.go-to').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const b = btn.getAttribute('data-book'), ch = btn.getAttribute('data-ch');
      document.querySelectorAll('.nav-btn').forEach(nb=> nb.classList.toggle('active', nb.dataset.page==='bible'));
      document.querySelectorAll('section.page').forEach(s=> s.classList.toggle('active', s.id==='bible'));
      (async ()=>{
        await ensureBookLoaded(b);
        populateChapters(b);
        bookSelect.value = b;
        chapterSelect.value = ch;
        renderChapter(b,ch);
        setTimeout(()=>{
          const verseNodes = Array.from(document.querySelectorAll('#versesContainer .verse'));
          const target = verseNodes.find(n => n.innerText.trim().startsWith(btn.getAttribute('data-v') + '.'));
          if(target) target.scrollIntoView({behavior:'smooth', block:'center'});
        }, 200);
      })();
    });
  });
}
function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }/* =========================
   MESSAGING (Firebase + E2E DMs scaffold)
   Requires Firestore security rules in production (see comments)
   ========================= */

/* Crypto helpers (Web Crypto API) */
const subtle = window.crypto.subtle;
async function generateECDHKeyPair(){ return await subtle.generateKey({ name: "ECDH", namedCurve: "P-256" }, true, ["deriveKey","deriveBits"]); }
async function exportPublicKeyBase64(publicKey){ const spki = await subtle.exportKey("raw", publicKey); return arrayBufferToBase64(spki); }
async function importPublicKeyFromBase64(b64){ const raw = base64ToArrayBuffer(b64); return subtle.importKey("raw", raw, { name: "ECDH", namedCurve: "P-256" }, true, []); }
async function deriveAESGCMKey(privateKey, otherPublicKey){ const derivedBits = await subtle.deriveBits({ name: "ECDH", public: otherPublicKey }, privateKey, 256); return subtle.importKey("raw", derivedBits, { name: "AES-GCM" }, false, ["encrypt","decrypt"]); }
function ivForNow(){ return window.crypto.getRandomValues(new Uint8Array(12)); }
async function encryptWithAESGCM(aesKey, plaintext){ const enc = new TextEncoder(); const iv = ivForNow(); const ct = await subtle.encrypt({ name: "AES-GCM", iv }, aesKey, enc.encode(plaintext)); return { iv: arrayBufferToBase64(iv.buffer), ciphertext: arrayBufferToBase64(ct) }; }
async function decryptWithAESGCM(aesKey, ivBase64, ctBase64){ try { const ivBuf = base64ToArrayBuffer(ivBase64); const ctBuf = base64ToArrayBuffer(ctBase64); const plainBuf = await subtle.decrypt({ name: "AES-GCM", iv: new Uint8Array(ivBuf) }, aesKey, ctBuf); return new TextDecoder().decode(plainBuf); } catch (e){ console.error("Decrypt failed", e); return null; } }
function arrayBufferToBase64(buffer){ const bytes = new Uint8Array(buffer); let binary = ''; for(let i=0;i<bytes.byteLength;i++) binary += String.fromCharCode(bytes[i]); return btoa(binary); }
function base64ToArrayBuffer(b64){ const binary = atob(b64); const len = binary.length; const bytes = new Uint8Array(len); for(let i=0;i<len;i++) bytes[i] = binary.charCodeAt(i); return bytes.buffer; }

/* Firestore handles */
let me = null; // { uid, displayName, keyPair, publicKeyBase64 }
async function bindMessaging(){
  // anonymous sign-in + keypair init + publish public key
  try {
    const res = await auth.signInAnonymously();
    me = { uid: res.user.uid };
    document.getElementById('meName').innerText = 'Signed in (uid: ' + me.uid + ')';
    // try load existing user doc
    const userDoc = await db.collection('users').doc(me.uid).get();
    if(userDoc.exists){ const data = userDoc.data(); me.displayName = data.displayName || ''; me.publicKeyBase64 = data.publicKey || null; document.getElementById('displayNameInput').value = me.displayName || ''; }
    // try sessionStorage private key
    const storedPriv = sessionStorage.getItem('it_priv_'+me.uid);
    if(storedPriv){
      try {
        const jwk = JSON.parse(atob(storedPriv));
        const priv = await subtle.importKey('jwk', jwk, { name:'ECDH', namedCurve:'P-256' }, true, ['deriveKey','deriveBits']);
        me.keyPair = { privateKey: priv };
      } catch(e){ console.warn('Failed import priv', e); }
    }
    if(!me.keyPair){
      const kp = await generateECDHKeyPair();
      me.keyPair = kp;
      const jwk = await subtle.exportKey('jwk', kp.privateKey);
      sessionStorage.setItem('it_priv_'+me.uid, btoa(JSON.stringify(jwk)));
      const pubRaw = await subtle.exportKey('raw', kp.publicKey);
      const pubB64 = arrayBufferToBase64(pubRaw);
      me.publicKeyBase64 = pubB64;
      await db.collection('users').doc(me.uid).set({ displayName: me.displayName || '', publicKey: pubB64, lastSeen: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
    } else {
      // ensure publicKey exists in Firestore
      if(!me.publicKeyBase64){
        const pubRaw = await subtle.exportKey('raw', me.keyPair.publicKey);
        const pubB64 = arrayBufferToBase64(pubRaw);
        me.publicKeyBase64 = pubB64;
        await db.collection('users').doc(me.uid).set({ publicKey: pubB64 }, { merge: true });
      }
    }
    await db.collection('users').doc(me.uid).set({ lastSeen: firebase.firestore.FieldValue.serverTimestamp(), online:true }, { merge:true });
    loadUsersList();
  } catch(e){
    console.error('Messaging init failed', e);
    document.getElementById('meName').innerText = 'Messaging init failed';
  }

  // UI bindings
  document.getElementById('btnSaveProfile').addEventListener('click', async ()=>{
    const name = document.getElementById('displayNameInput').value.trim();
    if(!me) return alert('Not signed in yet');
    me.displayName = name || 'Anonymous';
    await db.collection('users').doc(me.uid).set({ displayName: me.displayName }, { merge: true });
    document.getElementById('meName').innerText = me.displayName + ' (ready)';
    loadUsersList();
  });
  document.getElementById('btnRefreshUsers').addEventListener('click', loadUsersList);
  document.getElementById('btnCreateGroup').addEventListener('click', async ()=>{
    const name = document.getElementById('groupName').value.trim();
    if(!name) return alert('Enter group name');
    const groupRef = await db.collection('groups').add({ name, owner: me.uid, members: [me.uid], createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    alert('Group created: ' + name + '. GroupId: ' + groupRef.id);
  });

  document.getElementById('btnSend').addEventListener('click', async ()=>{
    const txt = document.getElementById('msgInput').value.trim();
    if(!txt) return;
    if(!currentChat) return alert('Open a DM or group first');
    if(currentChat.type !== 'dm') return alert('Only DMs supported in this demo for E2E sending');
    const otherUid = currentChat.other;
    const otherDoc = await db.collection('users').doc(otherUid).get();
    if(!otherDoc.exists) return alert('Recipient not found');
    const otherPubB64 = otherDoc.data().publicKey;
    if(!otherPubB64) return alert('Recipient has no public key saved');
    const otherPub = await importPublicKeyFromBase64(otherPubB64);
    const aesKey = await deriveAESGCMKey(me.keyPair.privateKey, otherPub);
    const enc = await encryptWithAESGCM(aesKey, txt);
    const msgDoc = { sender: me.uid, iv: enc.iv, ciphertext: enc.ciphertext, ts: firebase.firestore.FieldValue.serverTimestamp() };
    await db.collection('dms').doc(currentChat.id).collection('messages').add(msgDoc);
    document.getElementById('msgInput').value = '';
  });

  // presence updater
  setInterval(()=>{ if(me && me.uid) db.collection('users').doc(me.uid).set({ lastSeen: firebase.firestore.FieldValue.serverTimestamp(), online:true }, { merge:true }); }, 30000);
}

/* Users list */
async function loadUsersList(){
  const usersRef = db.collection('users').orderBy('displayName');
  const snap = await usersRef.limit(200).get();
  const list = document.getElementById('usersList'); list.innerHTML = '';
  snap.forEach(doc=>{
    const d = doc.data();
    if(doc.id === me.uid) return;
    const el = document.createElement('div');
    el.className = 'mess-user';
    el.innerHTML = `<div style="font-weight:800">${escapeHtml(d.displayName||'User')}</div>
                    <div style="color:var(--muted);font-size:.92rem">${doc.id}</div>
                    <div style="margin-top:6px"><button class="dm-btn" data-uid="${doc.id}" data-pub="${d.publicKey||''}">DM</button></div>`;
    list.appendChild(el);
  });
  document.querySelectorAll('.dm-btn').forEach(b=> b.addEventListener('click', ()=> openDM(b.dataset.uid)));
}

/* DM handling */
let currentChat = null;
function dmIdFor(u1,u2){ return [u1,u2].sort().join('_'); }
let unsubscribeMessages = null;

async function openDM(otherUid){
  if(!me) return alert('Not ready');
  currentChat = { type:'dm', id: dmIdFor(me.uid, otherUid), other: otherUid };
  document.getElementById('chatMeta').innerText = 'Direct chat with ' + otherUid;
  listenToMessages(currentChat);
}

async function listenToMessages(chat){
  if(unsubscribeMessages) unsubscribeMessages();
  document.getElementById('chatWindow').innerHTML = '';
  document.getElementById('chatStatus').innerText = 'Loading chat...';

  if(chat.type === 'dm'){
    const dmRef = db.collection('dms').doc(chat.id).collection('messages').orderBy('ts','asc');
    unsubscribeMessages = dmRef.onSnapshot(async snap => {
      document.getElementById('chatWindow').innerHTML = '';
      // render snapshot
      const docs = await dmRef.get();
      for(const doc of docs.docs){
        const m = doc.data();
        let decrypted = '[decryption failed]';
        try {
          const otherPubB64 = (chat.other === me.uid) ? null : (await db.collection('users').doc(chat.other).get()).data().publicKey;
          if(!otherPubB64){ decrypted = '[no public key available]'; }
          else {
            const otherPub = await importPublicKeyFromBase64(otherPubB64);
            const aesKey = await deriveAESGCMKey(me.keyPair.privateKey, otherPub);
            const plain = await decryptWithAESGCM(aesKey, m.iv, m.ciphertext);
            decrypted = plain || decrypted;
          }
        } catch(e){ console.warn('decrypt error', e); }
        appendMessageToWindow(m.sender, decrypted, m.ts && m.ts.toDate ? m.ts.toDate() : null);
      }
      document.getElementById('chatStatus').innerText = '';
    });
  } else {
    document.getElementById('chatStatus').innerText = 'Group chat listening not fully implemented in this demo.';
  }
}

function appendMessageToWindow(senderUid, text, ts){
  const wr = document.getElementById('chatWindow');
  const block = document.createElement('div');
  block.style.marginBottom = '8px';
  block.innerHTML = `<div style="font-weight:800">${senderUid} <span style="color:var(--muted);font-weight:600;font-size:.9rem">${ts? ' - '+ts.toLocaleString() : ''}</span></div><div style="margin-top:4px">${escapeHtml(text)}</div>`;
  wr.appendChild(block);
  wr.scrollTop = wr.scrollHeight;
}

/* =========================
   Utility helpers
   ========================= */
function escapeHtmlSimple(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>'); }

/* =========================
   Final: auto-init helpers
   ========================= */
function preloadInit(){
  // nothing here now
}
</script>

</body>
</html>

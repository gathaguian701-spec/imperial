<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>IMPERIAL TECHUB</title>
<link rel="icon" href="data:image/svg+xml;base64,PHN2ZyBmaWxsPSIjMDAyMzY2IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiI+PHRleHQgeD0iNCIgeT0iMjQiIGZvbnQtc2l6ZT0iMjQiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmaWxsPSJ3aGl0ZSI+SVQ8L3RleHQ+PC9zdmc+" />

<style>
  :root{
    --royal:#002366; --accent:#00b4ff; --muted: rgba(230,230,230,0.85);
    --card: rgba(255,255,255,0.04); --glass: rgba(255,255,255,0.03);
    --site-max:1100px;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family: Inter, "Segoe UI", Roboto, system-ui, -apple-system, "Helvetica Neue", Arial;
    background: linear-gradient(135deg,var(--royal), #003b99);
    color:#fff; -webkit-font-smoothing:antialiased;
  }
  main{max-width:var(--site-max);margin:20px auto;padding:0 16px;}

  /* Intro - EXACT 5 seconds */
  #intro{
    position:fixed; inset:0; display:flex; flex-direction:column; justify-content:center; align-items:center;
    background:#001F4D; z-index:9999; pointer-events:none; animation:introFade 5s linear forwards;
  }
  @keyframes introFade{0%{opacity:1}95%{opacity:1}100%{opacity:0;visibility:hidden}}
  #intro h1{font-size:clamp(2rem,6vw,4rem); color:#cfe9ff; font-weight:900; letter-spacing:2px; margin-bottom:12px;}
  .pulse{width:18px;height:18px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 rgba(0,180,255,0.4);animation:pulse 1.5s infinite}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(0,180,255,.45)}60%{box-shadow:0 0 0 26px rgba(0,180,255,0)}100%{box-shadow:0 0 0 0 rgba(0,180,255,0)}}

  #site{opacity:0;transition:opacity .35s ease-in-out}

  /* Top nav */
  .topbar{position:sticky;top:0;background:rgba(0,0,0,0.12);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,0.03);z-index:900}
  .nav-inner{max-width:var(--site-max);margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:10px 16px;gap:12px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#62d3ff);display:flex;align-items:center;justify-content:center;color:#012;font-weight:900}
  .nav-links{display:flex;gap:8px;flex-wrap:wrap}
  .nav-btn{background:transparent;border:0;color:#fff;padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer}
  .nav-btn.active{color:var(--accent);background:rgba(255,255,255,0.03)}

  /* Pages */
  section.page{display:none;opacity:0;transform:translateY(6px);transition:opacity .32s,transform .32s}
  section.page.active{display:block;opacity:1;transform:none}

  .card{background:var(--card);border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 26px rgba(0,0,0,0.35)}
  .center{text-align:center}
  h2{margin-bottom:8px}

  /* Events */
  .events-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px;margin-top:12px}
  .event-qty{font-weight:900;font-family:ui-monospace,monospace;font-size:1.25rem;color:var(--accent);margin-top:8px}
  .event-meta{color:var(--muted);font-size:.95rem;margin-top:8px}

  /* Leaders */
  .leaders-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
  .leader-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:10px}
  .contact-actions{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
  .wa-btn{background:linear-gradient(90deg,#25D366,#128C7E);color:#012;padding:8px 10px;border-radius:8px;font-weight:800;text-decoration:none}
  .call-btn{background:linear-gradient(90deg,#ffd54f,#ffb300);color:#012;padding:8px 10px;border-radius:8px;font-weight:700;text-decoration:none}

  /* Hymnbook */
  .hymn-search{display:flex;gap:8px;align-items:center;margin-bottom:12px}
  .hymn-search input{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--white)}
  .hymn-list{display:flex;flex-direction:column;gap:8px;max-height:420px;overflow:auto}
  .hymn-item{padding:12px;border-radius:10px;background:var(--glass);cursor:pointer}
  .hymn-lyrics{display:none;color:#e9f3ff;margin-top:8px;white-space:pre-line}

  /* Membership */
  .membership-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-top:12px}
  .membership-card{padding:16px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));text-align:center}
  .buy-btn{padding:10px 14px;border-radius:8px;border:0;background:var(--accent);color:#012;font-weight:800;cursor:pointer}

  /* Modal (Jitsi & MiniPay) */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;z-index:10000}
  .modal.show{display:flex}
  .modal-content{width:95%;max-width:1000px;background:#fff;border-radius:10px;overflow:hidden;color:#012}
  .modal-head{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:var(--royal);color:#fff}
  .modal-body{padding:0}
  .modal-iframe{width:100%;height:640px;border:0;display:block}
  .modal-close{background:#ff7676;border:0;color:#012;padding:8px 12px;border-radius:8px;cursor:pointer}

  /* Reader (Bible) */
  .reader { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding: 24px; border-radius:12px; margin-top:12px; color:#eaf6ff; }
  .reader .book-title{font-size:1.2rem;font-weight:900;margin-bottom:8px}
  .reader .chapter-title{font-size:1rem;font-weight:800;color:var(--muted);margin-bottom:12px}
  .reader .verse { margin:8px 0; font-size:1.05rem; line-height:1.6; color:#f7fbff; }
  .verse .num { font-weight:800; color:var(--accent); margin-right:8px; }
  .reader-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
  .select, .search { padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06); background:transparent; color:inherit }

  /* Light theme overrides */
  body.light-theme { background: linear-gradient(135deg,#f7fbff,#eaf6ff); color:#002246 }
  body.light-theme .card { background:#fff; color:#002246 }
  body.light-theme .reader { color:#0b2340 }
  .search-result { padding:10px;border-radius:8px;background:rgba(255,255,255,0.03); margin-bottom:8px }
  .search-result .meta { color:var(--muted); font-size:.95rem; margin-bottom:6px }

  footer{margin-top:22px;text-align:center;color:rgba(255,255,255,0.95);padding-bottom:28px}
  @media (max-width:760px){ .modal-iframe{height:420px} .reader .verse{font-size:1rem} }
</style>
</head>
<body>

<!-- INTRO -->
<div id="intro" aria-hidden="true">
  <h1>IMPERIAL TECHUB</h1>
  <div class="pulse"></div>
</div>

<!-- SITE -->
<div id="site" aria-hidden="true">
  <header class="topbar">
    <div class="nav-inner">
      <div class="brand"><div class="logo">IT</div><div class="title">IMPERIAL TECHUB</div></div>
      <nav class="nav-links" role="navigation" aria-label="Main">
        <button class="nav-btn active" data-page="home">HOME</button>
        <button class="nav-btn" data-page="events">EVENTS</button>
        <button class="nav-btn" data-page="announcements">ANNOUNCEMENTS</button>
        <button class="nav-btn" data-page="calendar">CALENDAR</button>
        <button class="nav-btn" data-page="leaders">LEADERS</button>
        <button class="nav-btn" data-page="hymnbook">HYMNBOOK</button>
        <button class="nav-btn" data-page="membership">MEMBERSHIP</button>
        <button class="nav-btn" data-page="video">VIDEO FELLOWSHIP</button>
        <button class="nav-btn" data-page="bible">BIBLE</button>
      </nav>
    </div>
  </header>

  <main>
    <!-- HOME -->
    <section id="home" class="page active">
      <div class="card center" style="max-width:900px;margin:18px auto">
        <h2>ðŸ’¡ Fun Fact</h2>
        <p id="funFact" style="font-size:1.05rem"></p>
        <small style="color:var(--muted)">New fact daily</small>
      </div>
    </section>

    <!-- EVENTS -->
    <section id="events" class="page">
      <div class="card">
        <h2>ðŸ“… Upcoming Events</h2>
        <div id="eventsGrid" style="margin-top:12px" class="events-grid"></div>
      </div>
    </section>

    <!-- ANNOUNCEMENTS -->
    <section id="announcements" class="page">
      <div class="card">
        <h2>ðŸ“£ Announcements</h2>
        <div style="margin-top:12px">
          <div class="card" style="margin-bottom:12px"><h3>PCEA NGORANO PARISH YOUTH RALLY</h3><p><strong>Sunday, 16th November 2025 â€” PCEA Chieni Church</strong></p><p>All youths are encouraged to attend for fellowship, worship, and spiritual growth.</p></div>
          <div class="card"><h3>PRESBYTERY YOUTH CONVENTION</h3><p><strong>Tuesday, 2nd December â€“ Saturday, 6th December 2025</strong></p><p>Charges: Ksh 1,500 per person (payable in instalments).</p></div>
        </div>
      </div>
    </section>

    <!-- CALENDAR -->
    <section id="calendar" class="page">
      <div class="card">
        <h2>ðŸ—“ Calendar</h2>
        <ul id="calendarList" style="margin-top:12px;color:var(--muted)"></ul>
      </div>
    </section>

    <!-- LEADERS -->
    <section id="leaders" class="page">
      <div class="card">
        <h2>ðŸ‘¥ Leaders & Contacts</h2>
        <div class="leaders-grid" id="leadersGrid" style="margin-top:12px"></div>
      </div>
    </section>

    <!-- HYMNBOOK -->
    <section id="hymnbook" class="page">
      <div class="card">
        <h2>ðŸŽµ Hymnbook</h2>
        <div style="margin-top:12px" class="hymn-search">
          <input id="hymnQuery" placeholder="Search hymn by title or any line..." class="select" />
          <button id="clearHymn" class="select">Clear</button>
        </div>
        <div id="hymnList" class="hymn-list"></div>
      </div>
    </section>

    <!-- MEMBERSHIP -->
    <section id="membership" class="page">
      <div class="card">
        <h2>ðŸ’› Support & Membership</h2>
        <p style="color:var(--muted)">Choose a tier to support youth activities. Payments via MiniPay.</p>
        <div style="margin-top:12px" class="membership-grid">
          <div class="membership-card">
            <h3>Gold</h3>
            <p><strong>Ksh 300 / month</strong></p>
            <button class="buy-btn" data-plan="Gold" data-amount="300">Buy Gold</button>
          </div>
          <div class="membership-card">
            <h3>Platinum</h3>
            <p><strong>Ksh 500 / month</strong></p>
            <button class="buy-btn" data-plan="Platinum" data-amount="500">Buy Platinum</button>
          </div>
          <div class="membership-card">
            <h3>Diamond</h3>
            <p><strong>Ksh 1000 / month</strong></p>
            <button class="buy-btn" data-plan="Diamond" data-amount="1000">Buy Diamond</button>
          </div>
        </div>
      </div>
    </section>

    <!-- VIDEO FELLOWSHIP -->
    <section id="video" class="page">
      <div class="card">
        <h2>ðŸŽ¥ Video Fellowship</h2>
        <p style="color:var(--muted)">Click Join Meeting to open a fresh meeting in a modal. Rooms are unique per session.</p>
        <div style="margin-top:12px"><button id="joinVideoBtn" class="buy-btn" style="background:var(--accent);color:#012">Join Meeting</button><button id="leaveVideoBtn" class="buy-btn" style="display:none;background:#ff7676;color:#012">Leave</button></div>
      </div>
    </section>

    <!-- BIBLE (Light/Dark + Full Search) -->
    <section id="bible" class="page">
      <div class="card">
        <div class="reader-controls" style="margin-bottom:12px">
          <select id="bookSelect" class="select"></select>
          <select id="chapterSelect" class="select"></select>
          <input id="verseSearch" class="search" placeholder="Search inside current chapter..." style="flex:1" />
          <button id="searchBibleBtn" class="select">Search Scripture (entire Bible)</button>
          <button id="toggleTheme" class="select" style="margin-left:auto">Toggle Light/Dark</button>
        </div>

        <div id="reader" class="reader">
          <div class="book-title" id="bookTitle">Genesis</div>
          <div class="chapter-title" id="chapterTitle">Chapter 1</div>
          <div id="versesContainer"></div>
        </div>

        <div id="searchResults" style="margin-top:14px"></div>
        <div id="searchStatus" style="margin-top:8px;color:var(--muted)"></div>
      </div>
    </section>

  </main>

  <footer>
    PROUDLY CREATED BY <strong>IAN GATHAGU</strong> â€” v1.3.5
  </footer>
</div>

<!-- MODALS -->
<div id="jitsiModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <div class="modal-head"><div>Youth Fellowship Meeting</div><div><button id="jitsiClose" class="modal-close">Leave</button></div></div>
    <div class="modal-body" id="jitsiBody"></div>
  </div>
</div>

<div id="mpModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <div class="modal-head"><div>Complete Payment</div><div><button id="mpClose" class="modal-close">Close</button></div></div>
    <div class="modal-body">
      <iframe id="mpIframe" src="" class="modal-iframe"></iframe>
    </div>
  </div>
</div>

<script>
/* ============ SITE BOOT (intro fix) ============ */
(function(){
  const intro = document.getElementById('intro');
  const site = document.getElementById('site');

  // Force-remove intro at exactly 5s
  setTimeout(()=>{ if(intro && intro.style.display!=='none'){ intro.style.display='none'; site.style.opacity='1'; initSite(); } },5000);

  // Also handle animationend for faster
  intro.addEventListener('animationend', ()=>{ intro.style.display='none'; site.style.opacity='1'; initSite(); });
})();

/* ============ INIT ============ */
function initSite(){
  bindNav();
  setFunFact();
  initEvents();
  renderCalendar();
  renderLeaders();
  loadHymns();
  bindMembershipButtons();
  preloadScript('https://meet.jit.si/external_api.js'); // prefetch
}

/* ============ NAV ============ */
function bindNav(){
  document.querySelectorAll('.nav-btn').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      showPage(b.dataset.page);
    });
  });
}
function showPage(page){
  document.querySelectorAll('section.page').forEach(s=> s.classList.toggle('active', s.id===page));
  window.scrollTo({top:0,behavior:'smooth'});
}

/* ============ FUN FACT ============ */
function setFunFact(){
  const facts = [
    "The Bible is the most translated book in the world.",
    "Jesus wept. (John 11:35)",
    "'Fear not' is written many times in scripture as encouragement.",
    "Psalm 117 is the shortest chapter."
  ];
  const today = new Date().toDateString();
  const saved = JSON.parse(localStorage.getItem('it_funFact') || 'null');
  if(!saved || saved.date !== today){
    const f = facts[Math.floor(Math.random()*facts.length)];
    localStorage.setItem('it_funFact', JSON.stringify({date:today,fact:f}));
    document.getElementById('funFact').innerText = f;
  } else {
    document.getElementById('funFact').innerText = saved.fact;
  }
}

/* ============ EVENTS ============ */
const EVENTS = [
  { id:'youth-rally', title:'Youth Rally â€” PCEA Chieni Church', start:'2025-11-16T09:00:00', end:'2025-11-16T17:00:00', location:'PCEA Chieni Church' },
  { id:'presbytery-convention', title:'Presbytery Youth Convention', start:'2025-12-02T09:00:00', end:'2025-12-06T18:00:00', location:'Presbytery Venue' },
  { id:'christmas', title:'Christmas Day', start:'2025-12-25T00:00:00', end:'2025-12-25T23:59:59', location:'All Parishes' },
  { id:'new-year', title:"New Year's Day", start:'2026-01-01T00:00:00', end:'2026-01-01T23:59:59', location:'All Parishes' }
];
let countdownInterval = null;
function initEvents(){
  EVENTS.forEach(e=>{ e.startDate=new Date(e.start); e.endDate=new Date(e.end); });
  renderEvents();
  if(countdownInterval) clearInterval(countdownInterval);
  countdownInterval = setInterval(updateCountdowns,1000);
  updateCountdowns();
}
function renderEvents(){
  const grid = document.getElementById('eventsGrid'); grid.innerHTML='';
  const now = new Date();
  const mapped = EVENTS.map(e=>{
    let diff;
    if(now>e.endDate) diff = Infinity;
    else if(now>=e.startDate && now<=e.endDate) diff = 0;
    else diff = e.startDate - now;
    return {...e,diff};
  }).sort((a,b)=>a.diff-b.diff);
  mapped.forEach(e=>{
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `<h3 style="margin:0">${e.title}</h3><div style="color:var(--muted);font-size:.95rem;margin-top:6px">${formatDateRange(e.startDate,e.endDate)}</div><div id="cd-${e.id}" style="margin-top:10px;font-family:ui-monospace,monospace;font-weight:900;color:var(--accent)">--d --h --m --s</div><div style="color:var(--muted);margin-top:8px">Location: ${e.location}</div>`;
    grid.appendChild(card);
  });
}
function updateCountdowns(){
  const now = new Date();
  EVENTS.forEach(e=>{
    const el = document.getElementById('cd-'+e.id); if(!el) return;
    if(now>e.endDate){ el.innerText='Event Passed'; el.style.color='rgba(255,255,255,0.6)'; return; }
    if(now>=e.startDate && now<=e.endDate){ el.innerText='Now Happening!'; el.style.color='#ffdd57'; return; }
    let diff = e.startDate - now;
    const days=Math.floor(diff/(24*60*60*1000)); diff-=days*(24*60*60*1000);
    const hours=Math.floor(diff/(60*60*1000)); diff-=hours*(60*60*1000);
    const mins=Math.floor(diff/(60*1000)); diff-=mins*(60*1000);
    const secs=Math.floor(diff/1000);
    el.innerText = `${pad(days)}d ${pad(hours)}h ${pad(mins)}m ${pad(secs)}s`;
  });
}
function formatDateRange(s,e){ const opts={year:'numeric',month:'short',day:'numeric'}; if(s.toDateString()===e.toDateString()) return s.toLocaleDateString(undefined,opts); return s.toLocaleDateString(undefined,opts)+' â€” '+e.toLocaleDateString(undefined,opts); }
function pad(n){ return String(n).padStart(2,'0'); }

/* ============ Calendar ============ */
function renderCalendar(){
  const ul = document.getElementById('calendarList'); ul.innerHTML='';
  EVENTS.forEach(e=>{ const li=document.createElement('li'); li.innerHTML=`<strong style="color:#fff">${e.title}</strong> â€” <span style="color:var(--muted)">${e.startDate.toDateString()}</span>`; ul.appendChild(li); });
}

/* ============ Leaders ============ */
function renderLeaders(){
  const leaders = [
    { office:"Zachary's Office", name:"Zachary Gikonyo", role:"Chairperson", phone:"+254742892647" },
    { office:"Dalson's Office", name:"Dalson Maina", role:"Vice Chairperson", phone:"+254714003648" },
    { office:"Ian's Office", name:"Ian Gathagu", role:"Secretary", phone:"+254718357417" },
    { office:"Lydia's Office", name:"Lydia Wamuyu", role:"Vice Secretary", phone:"+254110867929" },
    { office:"Winnie's Office", name:"Winnie Maundu", role:"Treasurer", phone:"+254713285534" }
  ];
  const grid=document.getElementById('leadersGrid'); grid.innerHTML='';
  leaders.forEach(ld=>{
    const el=document.createElement('div'); el.className='leader-card'; el.innerHTML=`<div style="font-weight:900">${ld.office}</div><div style="color:var(--muted)">${ld.name} â€” ${ld.role}</div><div style="margin-top:8px"><a class="wa-btn" href="https://wa.me/${ld.phone.replace(/\D/g,'')}" target="_blank">WhatsApp</a> <a class="call-btn" href="tel:${ld.phone.replace(/\D/g,'')}">Call</a> <span style="color:var(--muted);padding-left:8px">${ld.phone}</span></div>`; grid.appendChild(el);
  });
}

/* ============ Hymnbook ============ */
const HYMNS = [
  { title: "Amazing Grace", lyrics: "Amazing grace! How sweet the sound\nThat saved a wretch like me." },
  { title: "How Great Thou Art", lyrics: "O Lord my God, when I in awesome wonder..." },
  { title: "To God Be the Glory", lyrics: "To God be the glory, great things He hath done." }
];
function loadHymns(){ renderHymnList(''); const q=document.getElementById('hymnQuery'); const c=document.getElementById('clearHymn'); if(q) q.addEventListener('input', ()=>renderHymnList(q.value)); if(c) c.addEventListener('click', ()=>{ q.value=''; renderHymnList(''); }); }
function renderHymnList(filter){ const list=document.getElementById('hymnList'); list.innerHTML=''; const f=(filter||'').trim().toLowerCase(); const filtered=HYMNS.filter(h=>!f||h.title.toLowerCase().includes(f)||h.lyrics.toLowerCase().includes(f)); if(!filtered.length){ list.innerHTML='<div style="color:var(--muted);padding:8px">No hymns found.</div>'; return; } filtered.forEach(h=>{ const item=document.createElement('div'); item.className='hymn-item'; item.innerHTML=`<div style="font-weight:800">${h.title}</div><div class="hymn-lyrics">${escapeHtml(h.lyrics)}</div>`; item.addEventListener('click', ()=>{ document.querySelectorAll('.hymn-item .hymn-lyrics').forEach(x=>x.style.display='none'); const lyrics=item.querySelector('.hymn-lyrics'); lyrics.style.display = lyrics.style.display==='block' ? 'none' : 'block'; }); list.appendChild(item); }); }
function escapeHtml(txt){ return txt.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>'); }

/* ============ Membership (MiniPay modal) ============ */
function bindMembershipButtons(){
  const MERCHANT = encodeURIComponent('+254718357417');
  const BASE = 'https://checkout.minipay.co/checkout';
  document.querySelectorAll('.buy-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const plan = btn.dataset.plan || btn.getAttribute('data-plan') || btn.textContent.trim();
      const amount = btn.dataset.amount || btn.getAttribute('data-amount') || '100';
      const ref = makeRef(plan, amount);
      const params = new URLSearchParams({ merchant: MERCHANT, amount: amount, currency:'KES', reference: ref, description:`${plan} membership` });
      const url = `${BASE}?${params.toString()}`;
      document.getElementById('mpIframe').src = url;
      document.getElementById('mpModal').classList.add('show');
      setTimeout(()=>{ window.open(url,'_blank'); }, 3000); // fallback
    });
  });
  const mpClose = document.getElementById('mpClose');
  if(mpClose) mpClose.addEventListener('click', ()=>{ document.getElementById('mpIframe').src=''; document.getElementById('mpModal').classList.remove('show'); });
}
function makeRef(p,a){ const n=new Date(); return `IT-${p}-${n.getFullYear()}${String(n.getMonth()+1).padStart(2,'0')}${String(n.getDate()).padStart(2,'0')}-${n.getHours()}${n.getMinutes()}${n.getSeconds()}-${Math.floor(Math.random()*9000)+1000}`; }

/* ============ Jitsi modal (dynamic room) ============ */
(function(){
  const join = document.getElementById('joinVideoBtn'), leave=document.getElementById('leaveVideoBtn'), modal=document.getElementById('jitsiModal'), body=document.getElementById('jitsiBody'), close=document.getElementById('jitsiClose');
  let api=null,scriptLoaded=false;
  join.addEventListener('click', ()=>{
    if(api) return;
    loadJitsi(()=> {
      const room = makeRoom();
      const node = document.createElement('div'); node.id='jitsi-'+Date.now(); node.style.width='100%'; node.style.height='640px'; body.appendChild(node);
      try {
        api = new JitsiMeetExternalAPI('meet.jit.si',{ roomName: room, parentNode: node, width:'100%', height:640, configOverwrite:{prejoinPageEnabled:false}, interfaceConfigOverwrite:{TOOLBAR_BUTTONS:['microphone','camera','desktop','fullscreen','hangup','chat','participants-pane']} });
        modal.classList.add('show'); join.style.display='none'; leave.style.display='inline-block';
        api.addEventListener('videoConferenceLeft', cleanup);
      } catch(e){ console.error(e); alert('Could not start meeting.'); node.remove(); api=null; }
    });
  });
  leave.addEventListener('click', cleanup); close.addEventListener('click', cleanup);
  function cleanup(){ try{ if(api) api.dispose(); }catch(e){} api=null; body.innerHTML=''; modal.classList.remove('show'); join.style.display='inline-block'; leave.style.display='none'; window.scrollTo({top:0,behavior:'smooth'}); }
  function loadJitsi(cb){ if(scriptLoaded){ cb(); return; } const s=document.createElement('script'); s.src='https://meet.jit.si/external_api.js'; s.async=true; s.onload=()=>{ scriptLoaded=true; cb(); }; s.onerror=()=>{ alert('Unable to load video service'); }; document.head.appendChild(s); }
  function makeRoom(){ const now=new Date(); const Y=now.getFullYear(),M=String(now.getMonth()+1).padStart(2,'0'),D=String(now.getDate()).padStart(2,'0'),h=String(now.getHours()).padStart(2,'0'),m=String(now.getMinutes()).padStart(2,'0'),s=String(now.getSeconds()).padStart(2,'0'); return `PCEA-Center-Youth-${Y}${M}${D}-${h}${m}${s}-${Math.floor(Math.random()*9000)+1000}`; }
})();

/* ============ Helpers ============ */
function preloadScript(src){ const s=document.createElement('script'); s.src=src; s.async=true; s.onload=()=>console.log('preloaded',src); s.onerror=()=>console.log('failed preload',src); document.head.appendChild(s); }

/* ============ BIBLE READER (Light/Dark + Full Search) ============ */

/*
  Instructions:
  - Upload your 66 KJV txt files in /bible/ with names matching the BOOKS array (Book + '.txt')
  - The reader fetches and caches files in-browser. Full-Bible search fetches all files (cached after first run).
*/

// Books array (must match filenames in /bible/)
const BOOKS = [
  "Genesis","Exodus","Leviticus","Numbers","Deuteronomy","Joshua","Judges","Ruth",
  "1 Samuel","2 Samuel","1 Kings","2 Kings","1 Chronicles","2 Chronicles","Ezra","Nehemiah",
  "Esther","Job","Psalms","Proverbs","Ecclesiastes","Song of Solomon","Isaiah","Jeremiah",
  "Lamentations","Ezekiel","Daniel","Hosea","Joel","Amos","Obadiah","Jonah",
  "Micah","Nahum","Habakkuk","Zephaniah","Haggai","Zechariah","Malachi",
  "Matthew","Mark","Luke","John","Acts","Romans","1 Corinthians","2 Corinthians",
  "Galatians","Ephesians","Philippians","Colossians","1 Thessalonians","2 Thessalonians",
  "1 Timothy","2 Timothy","Titus","Philemon","Hebrews","James","1 Peter","2 Peter",
  "1 John","2 John","3 John","Jude","Revelation"
];

const BIBLE_BASE = '/bible/'; // folder where the .txt files are hosted

const bookSelect = document.getElementById('bookSelect');
const chapterSelect = document.getElementById('chapterSelect');
const bookTitle = document.getElementById('bookTitle');
const chapterTitle = document.getElementById('chapterTitle');
const versesContainer = document.getElementById('versesContainer');
const verseSearch = document.getElementById('verseSearch');
const searchBibleBtn = document.getElementById('searchBibleBtn');
const searchResults = document.getElementById('searchResults');
const searchStatus = document.getElementById('searchStatus');
const toggleThemeBtn = document.getElementById('toggleTheme');

let bookCache = {}; // raw book text cache
let parsedCache = {}; // parsed chapters cache: { book: { chapterNumber: [ {verse, text}, ... ] } }

// Initialize Bible UI
(function initBibleUI(){
  // build select list
  BOOKS.forEach(b => {
    const opt = document.createElement('option'); opt.value = b; opt.textContent = b; bookSelect.appendChild(opt);
  });

  // theme init
  const theme = localStorage.getItem('it_theme') || 'dark';
  setTheme(theme);

  // bindings
  bookSelect.addEventListener('change', async () => {
    await ensureBookLoaded(bookSelect.value);
    populateChapters(bookSelect.value);
    chapterSelect.selectedIndex = 0;
    chapterSelect.dispatchEvent(new Event('change'));
  });

  chapterSelect.addEventListener('change', () => {
    renderChapter(bookSelect.value, chapterSelect.value);
  });

  verseSearch.addEventListener('input', () => {
    const q = verseSearch.value.trim().toLowerCase();
    document.querySelectorAll('#versesContainer .verse').forEach(v => {
      v.style.display = (q === '' || v.innerText.toLowerCase().includes(q)) ? '' : 'none';
    });
  });

  searchBibleBtn.addEventListener('click', () => {
    const q = verseSearch.value.trim();
    if(!q) {
      alert('Type a word or phrase in the search box first to search the whole Bible.');
      return;
    }
    searchWholeBible(q);
  });

  toggleThemeBtn.addEventListener('click', () => {
    const current = document.body.classList.contains('light-theme') ? 'light' : 'dark';
    setTheme(current === 'light' ? 'dark' : 'light');
  });

  // pre-select Genesis & load sample (fast)
  bookSelect.value = 'Genesis';
  (async ()=>{ await ensureBookLoaded('Genesis'); populateChapters('Genesis'); chapterSelect.value = '1'; chapterSelect.dispatchEvent(new Event('change')); })();
})();

function setTheme(mode){
  if(mode === 'light'){ document.body.classList.add('light-theme'); localStorage.setItem('it_theme','light'); toggleThemeBtn.innerText='Dark Mode'; }
  else { document.body.classList.remove('light-theme'); localStorage.setItem('it_theme','dark'); toggleThemeBtn.innerText='Light Mode'; }
}

async function ensureBookLoaded(book){
  if(bookCache[book]) return;
  const filename = book + '.txt';
  searchStatus.innerText = `Loading ${book} ...`;
  try {
    const res = await fetch(BIBLE_BASE + filename);
    if(!res.ok) throw new Error('Book file not found: ' + filename);
    const txt = await res.text();
    bookCache[book] = txt;
    parsedCache[book] = parseBookToChapters(txt);
  } catch(err){
    console.error(err);
    searchStatus.innerText = `Failed loading ${book}. Check /bible/${filename}`;
    parsedCache[book] = {};
  } finally {
    setTimeout(()=>{ searchStatus.innerText = ''; }, 800);
  }
}

function parseBookToChapters(txt){
  const byLines = txt.replace(/\r\n/g,'\n').split('\n');
  let chapters = {};
  const chapterIndices = [];
  for(let i=0;i<byLines.length;i++){
    if(/^\s*(CHAPTER|Chapter)\s+\d+/i.test(byLines[i])) chapterIndices.push(i);
  }
  if(chapterIndices.length > 0){
    for(let c=0;c<chapterIndices.length;c++){
      const start = chapterIndices[c];
      const end = (c+1<chapterIndices.length) ? chapterIndices[c+1] : byLines.length;
      const m = byLines[start].match(/(\d+)/);
      const chapNum = m ? m[1] : String(c+1);
      const body = byLines.slice(start+1,end).join('\n').trim();
      chapters[chapNum] = splitVerses(body);
    }
    return chapters;
  }

  const fullText = byLines.join('\n').trim();
  const versesDetected = byLines.find(l=>l && /^\s*\d+\s+/.test(l));
  if(versesDetected){
    chapters['1'] = splitVerses(fullText);
    return chapters;
  }

  // fallback chunking
  const words = fullText.split(/\s+/);
  const chunkSize = 2000;
  let chapterCount = Math.ceil(words.length / chunkSize);
  for(let i=0;i<chapterCount;i++){
    const chunkWords = words.slice(i*chunkSize, (i+1)*chunkSize);
    chapters[String(i+1)] = [{verse:'1', text: chunkWords.join(' ')}];
  }
  return chapters;
}

function splitVerses(body){
  const pieces = [];
  const txt = body.replace(/\r\n/g,'\n');
  const verseRegex = /(^|\n)\s*(\d+)[\).\:]?\s*/g;
  let match;
  const indices = [];
  while((match = verseRegex.exec(txt)) !== null){
    indices.push({index: match.index + match[1].length, num: match[2]});
  }
  if(indices.length > 0){
    for(let i=0;i<indices.length;i++){
      const start = indices[i].index;
      const num = indices[i].num;
      const end = (i+1<indices.length) ? indices[i+1].index : txt.length;
      const verseText = txt.slice(start + String(num).length).replace(/^[\s\)\.:-]*/,'').slice(0, end - (start + String(num).length)).trim();
      pieces.push({verse: num, text: verseText});
    }
    return pieces;
  }
  const paras = txt.split(/\n\s*\n/).filter(Boolean);
  if(paras.length > 1){
    return paras.map((p, idx)=>({verse: String(idx+1), text: p.trim()}));
  }
  return [{verse:'1', text: txt.trim()}];
}

function populateChapters(book){
  const chapters = parsedCache[book] ? Object.keys(parsedCache[book]) : [];
  chapterSelect.innerHTML = '';
  chapters.forEach(c=>{
    const o = document.createElement('option'); o.value = c; o.textContent = 'Chapter ' + c; chapterSelect.appendChild(o);
  });
}

function renderChapter(book, chapter){
  const ch = (parsedCache[book] && parsedCache[book][String(chapter)]) || [];
  bookTitle.innerText = book;
  chapterTitle.innerText = 'Chapter ' + chapter;
  versesContainer.innerHTML = '';
  ch.forEach(v=>{
    const d = document.createElement('div');
    d.className='verse';
    d.innerHTML = `<span class="num">${v.verse}.</span> ${escapeHtml(v.text)}`;
    versesContainer.appendChild(d);
  });
  searchResults.innerHTML = '';
}

/* Full Bible search */
async function searchWholeBible(query){
  query = String(query || '').trim();
  if(!query) return;
  searchResults.innerHTML = '';
  searchStatus.innerText = 'Searching entire Bible...';
  const qLower = query.toLowerCase();
  const matches = [];

  for(let i=0;i<BOOKS.length;i++){
    const book = BOOKS[i];
    if(!bookCache[book]) {
      try { await ensureBookLoaded(book); } catch(e){ console.warn('Failed loading', book); }
    }
    const chapters = parsedCache[book] || {};
    for(const chNum of Object.keys(chapters)){
      const verses = chapters[chNum];
      for(const v of verses){
        if(v.text && v.text.toLowerCase().includes(qLower)){
          const idx = v.text.toLowerCase().indexOf(qLower);
          const start = Math.max(0, idx - 40);
          const end = Math.min(v.text.length, idx + qLower.length + 40);
          const snippet = (start>0 ? '...':'') + v.text.slice(start,end).replace(new RegExp(escapeRegExp(query),'ig'), (m)=>`<strong style="background:var(--accent);color:#012;padding:0 2px">${m}</strong>`) + (end < v.text.length ? '...':'');
          matches.push({book, chapter: chNum, verse: v.verse, snippet});
        }
      }
    }
    searchStatus.innerText = `Searching: ${book} (${i+1}/${BOOKS.length}) â€” found ${matches.length} matches`;
    await new Promise(r=>setTimeout(r,10));
  }

  searchStatus.innerText = `Search complete â€” ${matches.length} matches`;
  if(matches.length===0){
    searchResults.innerHTML = `<div class="search-result">No results for "<strong>${escapeHtml(query)}</strong>".</div>`;
    return;
  }

  const grouped = {};
  matches.forEach(m=>{
    const key = `${m.book}__${m.chapter}`;
    (grouped[key] = grouped[key]||{book:m.book,chapter:m.chapter,items:[]}).items.push(m);
  });

  const frag = document.createDocumentFragment();
  Object.values(grouped).forEach(g=>{
    const box = document.createElement('div'); box.className = 'search-result';
    const meta = document.createElement('div'); meta.className='meta'; meta.innerHTML = `<strong>${escapeHtml(g.book)}</strong> â€” Chapter ${g.chapter} â€” ${g.items.length} match(es)`;
    box.appendChild(meta);
    g.items.forEach(it => {
      const sn = document.createElement('div'); sn.className='match-snippet'; sn.innerHTML = `<div style="margin-bottom:6px">${it.snippet}</div><div style="color:var(--muted);font-size:.95rem">${it.book} ${it.chapter}:${it.verse} <button data-book="${it.book}" data-ch="${it.chapter}" data-v="${it.verse}" class="select go-to">Open</button></div>`;
      box.appendChild(sn);
    });
    frag.appendChild(box);
  });
  searchResults.innerHTML = '';
  searchResults.appendChild(frag);

  document.querySelectorAll('.go-to').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const b = btn.getAttribute('data-book'), ch = btn.getAttribute('data-ch');
      document.querySelectorAll('.nav-btn').forEach(nb=> nb.classList.toggle('active', nb.dataset.page==='bible'));
      document.querySelectorAll('section.page').forEach(s=> s.classList.toggle('active', s.id==='bible'));
      (async ()=>{
        await ensureBookLoaded(b);
        populateChapters(b);
        bookSelect.value = b;
        chapterSelect.value = ch;
        renderChapter(b,ch);
        setTimeout(()=>{
          const verseNodes = Array.from(document.querySelectorAll('#versesContainer .verse'));
          const target = verseNodes.find(n => n.innerText.trim().startsWith(btn.getAttribute('data-v') + '.'));
          if(target) target.scrollIntoView({behavior:'smooth', block:'center'});
        }, 200);
      })();
    });
  });
}

function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }

/* ============ END BIBLE ============ */

</script>
</body>
</html>
